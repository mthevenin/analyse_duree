---
title: "Variables dynamiques"
---

Cette section sera principalement traitée par l'exemple, et on ne s'intéressera qu'aux variables de type discrète, avec un seul changement d'état.

-   Dans un modèle de durée, une variable dynamique peut-être appréhendée comme une intéraction entre la durée et une variable quantitative.
-   Pour un modèle de Cox, l'hypothèse de risque proportionnel ne peut donc pas être testée sur la variable d'origine.
-   Ne pas tenir compte du caractère dynamique d'une dimension peut conduire à des interprétations erronées.
-   Warning: La façon de modéliser les dimensions dynamiques en analyse des durées peut conduire à des biais de causalité, en particulier dans les sciences sociales, en omettant les effets d'anticipation. C'est une situation classique avec des covariables dynamiques de type discrètes. Les techniques standards ne peuvent modéliser que des effets d'adaptation : la cause - observée - précède l'effet.

# Facteur dynamique traitée de manière fixe

On reprend l'exemple sur malformation cardiaque, en ajoutant la variable relative à la greffe. La question est donc: une transplantation du coeur réduit-elle le risque journalier de décéder (ou augmente la durée de survie).  
On a dans la base 2 variables: une variable binaire pour savoir si l'individu à été greffé ou non, **tranplant**, et la variable *wait* de type continue tronquée  donnant la durée en jour jusqu'à l'opération depuis l'inscription dans le registre (0 si $transplant=0$).   
On va dans un premier temps estimer le modèle (de Cox) avec la variable fixe *transplant*.   

```{r eval=FALSE}

------------------------------------------------------------------------------
          _t | Haz. ratio   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
        year |      0.926      0.061    -1.16   0.246        0.813       1.055
         age |      1.058      0.015     3.91   0.000        1.029       1.089
     surgery |      0.537      0.241    -1.38   0.167        0.223       1.296
  transplant |      0.251      0.079    -4.38   0.000        0.135       0.466
        wait |      0.993      0.005    -1.48   0.139        0.983       1.002
------------------------------------------------------------------------------

```

Interprétation: traité de manière fixe, la greffe réduit donc sensiblement le risque journalier de décéder 

Au niveau des données le modèle à été estimé, pour une personne greffée (ici id=70), à partir de ce mapping:

```{r eval=FALSE}
      +-------------------------------------------------------------+
      | id   year   age   surgery   transp~t   wait   _d   _t   _t0 |
      |-------------------------------------------------------------|
1896. | 70     72    52         0          1      5    0    1     0 |
1897. | 70     72    52         0          1      5    0    2     1 |
1898. | 70     72    52         0          1      5    0    3     2 |
1899. | 70     72    52         0          1      5    0    5     3 |
1900. | 70     72    52         0          1      5    0    6     5 |
      |-------------------------------------------------------------|
1901. | 70     72    52         0          1      5    0    8     6 |
1902. | 70     72    52         0          1      5    0    9     8 |
1903. | 70     72    52         0          1      5    0   12     9 |
1904. | 70     72    52         0          1      5    0   16    12 |
1905. | 70     72    52         0          1      5    0   17    16 |
      |-------------------------------------------------------------|
1906. | 70     72    52         0          1      5    0   18    17 |
1907. | 70     72    52         0          1      5    0   21    18 |
1908. | 70     72    52         0          1      5    0   28    21 |
1909. | 70     72    52         0          1      5    1   30    28 |
      +-------------------------------------------------------------+
```

**Problème**: une personne est codée greffée avant le jour de la transplantation. L'effet *causal* est donc mal mesuré si sa dimension temporelle a été ignorée, ici le jour exact de l'opération. C'est le même principe pour l'évènement, la personne est codée décédée (1) le jour du décès, et vivante avant (0).  
<br>

# Estimation avec une variable dynamique

Il convient donc de modifier l'information avec le délai d'attente jusqu'à la greffe. Quel que soit le logiciel, le principe de construction de la variable suit la logique suivante:\
$tvc = transplant$ , si $transplant=1$ et $_t<wait$ alors $tvc=0$.

### Modèle de Cox

```{r eval=FALSE}
  +---------------------------------------------------------------------+
  | id   year   age   surgery   tvc   wait   _d          _t         _t0 |
  |---------------------------------------------------------------------|
  | 10     68    42         0     0     12    0           1           0 |
  | 10     68    42         0     0     12    0           2           1 |
  | 10     68    42         0     0     12    0           3           2 |
  | 10     68    42         0     0     12    0           5           3 |
  | 10     68    42         0     0     12    0   5.0999999           5 |
  |---------------------------------------------------------------------|
  | 10     68    42         0     0     12    0           6   5.0999999 |
  | 10     68    42         0     0     12    0           8           6 |
  | 10     68    42         0     0     12    0           9           8 |
  | 10     68    42         0     1     12    0          12           9 |
  | 10     68    42         0     1     12    0          16          12 |
  |---------------------------------------------------------------------|
  | 10     68    42         0     1     12    0          17          16 |
  | 10     68    42         0     1     12    0          18          17 |
  | 10     68    42         0     1     12    0          21          18 |
  | 10     68    42         0     1     12    0          28          21 |
  | 10     68    42         0     1     12    0          30          28 |
  |---------------------------------------------------------------------|
  | 10     68    42         0     1     12    0          32          30 |
  | 10     68    42         0     1     12    0          35          32 |
  | 10     68    42         0     1     12    0          36          35 |
  | 10     68    42         0     1     12    0          37          36 |
  | 10     68    42         0     1     12    0          39          37 |
  |---------------------------------------------------------------------|
  | 10     68    42         0     1     12    0          40          39 |
  | 10     68    42         0     1     12    0          43          40 |
  | 10     68    42         0     1     12    0          45          43 |
  | 10     68    42         0     1     12    0          50          45 |
  | 10     68    42         0     1     12    0          51          50 |
  |---------------------------------------------------------------------|
  | 10     68    42         0     1     12    0          53          51 |
  | 10     68    42         0     1     12    1          58          53 |
  +---------------------------------------------------------------------+
```

Maintenant, si on estime le modèle avec cette variable dynamique qui indique clairement le moment de la transition (jour de la greffe):

```{r eval=FALSE}

Cox regression with Efron method for ties

No. of subjects =    103                                Number of obs =  3,573
No. of failures =     75
Time at risk    = 31,938
                                                        LR chi2(4)    =  17.70
Log likelihood = -289.27014                             Prob > chi2   = 0.0014

------------------------------------------------------------------------------
          _t | Haz. ratio   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
        year |      0.887      0.060    -1.79   0.074        0.777       1.012
         age |      1.031      0.014     2.19   0.029        1.003       1.059
     surgery |      0.374      0.163    -2.25   0.024        0.159       0.880
         tvc |      0.921      0.281    -0.27   0.787        0.507       1.674
------------------------------------------------------------------------------

```

L'impact de la greffe apparaît maintenant bien plus contestable sur la survie des individus, tout du moins elle ne l'augmente pas. Cela ne signifie pas non plus que des personnes ont pu être "sauvée" grâce à cette opération (ou plutôt leur durée de vie augmentée), mais des complications lors de l'opération ou post-opératoire, surtout à une époque où ces techniques étaient à leurs balbutiements, ont pu également accélérer la mortalité  par rapport à une personne non (encore) greffée.


## Cox: solutions logiciels

::: panel-tabset
### Sas

La base n'est pas modifiée et la création de la TVC est faite "en aveugle" dans la procédure `phreg`, après l'instruction `model`. Ce n'est pas super.

### R - Stata, Python

La base doit être transformée en format long aux temps d'évènement (`survsplit` avec R, `stsplit` avec Stata) avant la création de la variable dynamique.
:::

### Modèle à temps discret

Même principe pour la construction de la variable dynamique. Pour rappel l'échelle temporelle est le mois, et on a créé en amont une variable qui transforme les jour d'attente en mois (*mwait*).

```{r eval=FALSE}
+---------------------------------------------+
  | id   year   age   surgery   tvc   mwait   t |
  |---------------------------------------------|
  | 13     68    54         0     0       2   1 |
  | 13     68    54         0     1       2   2 |
  | 13     68    54         0     1       2   3 |
  +---------------------------------------------+


Logistic regression                             Number of obs     =      1,127
                                                LR chi2(7)        =      90.73
                                                Prob > chi2       =     0.0000
Log likelihood = -230.32152                     Pseudo R2         =     0.1645

------------------------------------------------------------------------------
           e |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           t |   -.365048   .0915105    -3.99   0.000    -.5444052   -.1856907
          t2 |   .0139226   .0053256     2.61   0.009     .0034846    .0243606
          t3 |   -.000162   .0000815    -1.99   0.047    -.0003217   -2.27e-06
        year |  -.1324928   .0737516    -1.80   0.072    -.2770433    .0120577
         age |    .033829   .0149503     2.26   0.024      .004527    .0631311
     surgery |  -1.007795   .4490177    -2.24   0.025    -1.887854   -.1277365
         tvc |  -.0543011   .3114096    -0.17   0.862    -.6646528    .5560505
------------------------------------------------------------------------------
Remarque : la constante n’est pas reportée, les valeurs de la référence
n’ayant pas grand  sens (année et âge à 0)
```

# Précautions

*   Rappel: la cause doit précède l'effet.

*   Lorsque l'évènement étudié n'est pas intrinsèquement de type absorbant comme le décès, la « cause » peut se manifester ou plutôt être observée après la survenue de l'évènement étudié.Les modèles de durée standards ne peuvent pas gérer ces situations car l'observation sort du risque après la survenue de l'évènement.

* Même si la cause est bien mesurée avant l'évènement d'intérêt, un « choc » n'est peut-être qu'un point final d'un processus causal antérieur: une séparation est rarement un évènement ponctuel, une phase plus ou moins longue de mésentente dans le couple lui a vraisemblablement préexister. La datation du début d'un processus causal n'est donc pas toujours facile à mesurer.
  * **Logique d'adaptation**: la « cause » identifiée est mesurée avant l'évènement étudié.
  * **Logique d'anticipation**: la « cause » identifiée est mesurée après l'occurrence de l'évènement étudié. L'origine causale est bien antérieure à l'évènement, mais elle n'est pas directement observable.

-   Lorsque les variables dynamiques sont de type quantitatives/continues, le problème on doit aussi considérer avec des phénomènes d'anticipation sur les valeurs attendues de ces variables, observées postérieurement à l'évènement étudié. On peut introduire des « lags » dans le modèle pour saisir ce phénomène : par exemple $x_t= x_{t+1}$. Ce décalage des durées d'occurrence peut être aussi introduite pour les variables discrètes (naissance d'un enfant par exemple).
