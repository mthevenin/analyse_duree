{
  "hash": "5d5f7e791e7a01dc43be3175691d6a33",
  "result": {
    "markdown": "---\nfilters:\n  - lightbox\nlightbox: auto\n---\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE, render = knitr::normal_print)\nlibrary(knitr)\nlibrary (rsconnect)\nlibrary(memisc)\n```\n\n\n\n# **Stata**\n\n\nOuverture de la base\n\n::: {.cell execution_count=1}\n``` {.stata .cell-code}\nwebuse set \"https://raw.githubusercontent.com//mthevenin/analyse_duree/master/bases/\"\nwebuse  \"transplantation_m\", clear\nwebuse set\n\n\nlist id year age surgery stime died in 1/10\n```\n\n::: {.cell-output .cell-output-display}\n```\n<IPython.core.display.HTML object>\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n(prefix now \"https://raw.githubusercontent.com//mthevenin/analyse_duree/master/\n> bases\")\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n(SAVASTATA created this dataset on 01AUG2019)\n(prefix now \"https://www.stata-press.com/data/r18\")\n\n     +------------------------------------------+\n     | id   year   age   surgery   stime   died |\n     |------------------------------------------|\n  1. | 15     68    53         0       1      1 |\n  2. | 43     70    43         0       2      1 |\n  3. | 61     71    52         0       2      1 |\n  4. | 75     72    52         0       2      1 |\n  5. |  6     68    54         0       3      1 |\n     |------------------------------------------|\n  6. | 42     70    36         0       3      1 |\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n  7. | 54     71    47         0       3      1 |\n  8. | 38     70    41         0       5      1 |\n  9. | 85     73    47         0       5      1 |\n 10. |  2     68    51         0       6      1 |\n     +------------------------------------------+\n```\n:::\n:::\n\n\n## Analyse non paramétrique\n\n### Méthode actuarielle\n\nContrairement à la formation, l'estimation sera faite sur des intervalles de 30 jours\n\n::: {.cell execution_count=2}\n``` {.stata .cell-code}\nltable stime died, interval(30)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n                 Beg.                                 Std.\n   Interval     total   Deaths   Lost   Survival     error     [95% conf. int.]\n-------------------------------------------------------------------------------\n    0    30       103       22      1     0.7854    0.0406     0.6926    0.8531\n   30    60        80       14      2     0.6462    0.0475     0.5449    0.7305\n   60    90        64       12      0     0.5250    0.0498     0.4232    0.6171\n   90   120        52        5      1     0.4741    0.0499     0.3738    0.5677\n  120   150        46        1      1     0.4636    0.0499     0.3637    0.5575\n  150   180        44        2      0     0.4426    0.0498     0.3435    0.5369\n  180   210        42        3      1     0.4106    0.0495     0.3132    0.5053\n  210   240        38        1      0     0.3998    0.0494     0.3030    0.4945\n  240   270        37        1      1     0.3888    0.0492     0.2928    0.4836\n  270   300        35        2      0     0.3666    0.0488     0.2720    0.4614\n  300   330        33        1      0     0.3555    0.0486     0.2618    0.4502\n  330   360        32        3      1     0.3216    0.0478     0.2308    0.4157\n  360   390        28        0      1     0.3216    0.0478     0.2308    0.4157\n  390   420        27        0      1     0.3216    0.0478     0.2308    0.4157\n  420   450        26        0      2     0.3216    0.0478     0.2308    0.4157\n  480   510        24        0      1     0.3216    0.0478     0.2308    0.4157\n  510   540        23        0      1     0.3216    0.0478     0.2308    0.4157\n  540   570        22        0      1     0.3216    0.0478     0.2308    0.4157\n  570   600        21        1      1     0.3059    0.0479     0.2155    0.4010\n  600   630        19        0      1     0.3059    0.0479     0.2155    0.4010\n  660   690        18        1      1     0.2885    0.0483     0.1982    0.3849\n  720   750        16        1      0     0.2704    0.0485     0.1807    0.3681\n  840   870        15        1      1     0.2518    0.0486     0.1629    0.3506\n  900   930        13        0      1     0.2518    0.0486     0.1629    0.3506\n  930   960        12        0      1     0.2518    0.0486     0.1629    0.3506\n  960   990        11        1      0     0.2289    0.0493     0.1404    0.3304\n  990  1020        10        1      0     0.2060    0.0494     0.1192    0.3093\n 1020  1050         9        1      0     0.1831    0.0489     0.0992    0.2873\n 1140  1170         8        0      1     0.1831    0.0489     0.0992    0.2873\n 1320  1350         7        0      1     0.1831    0.0489     0.0992    0.2873\n 1380  1410         6        1      2     0.1465    0.0510     0.0645    0.2602\n 1560  1590         3        0      2     0.1465    0.0510     0.0645    0.2602\n 1770  1800         1        0      1     0.1465    0.0510     0.0645    0.2602\n-------------------------------------------------------------------------------\n```\n:::\n:::\n\n\n![](images/Image7.png)\n\n**Récupération des quartiles de la durée**  \n\n\nInstallation de la commande `qlt`\n\n::: {.cell execution_count=3}\n``` {.stata .cell-code}\nnet install qlt, from(\"https://raw.githubusercontent.com/mthevenin/analyse_duree/master/ado/qlt/\") replace\n\n* help qlt\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nchecking qlt consistency and verifying not already installed...\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nall files already exist and are up to date.\n```\n:::\n:::\n\n\n::: {.cell execution_count=4}\n``` {.stata .cell-code}\nqui ltable stime died, interval(30) saving(base, replace)\nuse base, clear\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(SAVASTATA created this dataset on 01AUG2019)\n```\n:::\n:::\n\n\n::: {.cell execution_count=5}\n``` {.stata .cell-code}\nqlt\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nDuree pour differents quantiles de la fonction de survie\nDefinition des bornes Stata-ltable\nS(t)=0.90: t=        .\nS(t)=0.75: t=    7.623\nS(t)=0.50: t=   74.729\nS(t)=0.25: t=  849.325\nS(t)=0.10: t=        .\n```\n:::\n:::\n\n\nAvec la définition des bornes des intervalles de Sas\n\n::: {.cell execution_count=6}\n``` {.stata .cell-code}\nqlt, sas\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nDuree pour differents quantiles de la fonction de survie\nDefinition des bornes Sas-lifetest\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nS(t)=0.90: t=   13.977\nS(t)=0.75: t=   37.623\nS(t)=0.50: t=  104.729\nS(t)=0.25: t=  906.993\nS(t)=0.10: t=        .\n```\n:::\n:::\n\n\n### Méthode Kaplan-Meier\n\n**Mode analyse des durées: stset**\n\nLes données doivent être mises en mode analyse de durée (`help stset`)\n\n::: {.cell execution_count=7}\n\n::: {.cell-output .cell-output-stdout}\n```\n(prefix now \"https://raw.githubusercontent.com//mthevenin/analyse_duree/master/\n> bases\")\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n(SAVASTATA created this dataset on 01AUG2019)\n(prefix now \"https://www.stata-press.com/data/r18\")\n```\n:::\n:::\n\n\n::: {.cell execution_count=8}\n``` {.stata .cell-code}\nstset stime, f(died)\n\nstci\n\n*list id stime died _st _d _t _t0 in 1/10\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nSurvival-time data settings\n\n         Failure event: died!=0 & died<.\nObserved time interval: (0, stime]\n     Exit on or before: failure\n\n--------------------------------------------------------------------------\n        103  total observations\n          0  exclusions\n--------------------------------------------------------------------------\n        103  observations remaining, representing\n         75  failures in single-record/single-failure data\n     31,938  total analysis time at risk and under observation\n                                                At risk from t =         0\n                                     Earliest observed entry t =         0\n                                          Last observed exit t =     1,799\n\n        Failure _d: died\n  Analysis time _t: stime\n\n             | Number of \n             |  subjects         50%      Std. err.    [95% conf. interval]\n-------------+-------------------------------------------------------------\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n       Total |       103         100      38.64425           69        219\n```\n:::\n:::\n\n\n**Estimation de la fonction de survie**  \n\n\n\n```{r eval=FALSE}\nsts list\n```\n\n```{r eval=FALSE}\nsts graph\n```\n\n\n\n![](images/Image8.png){width=70%}\n\n### Comparaison des fonctions de survie (KM)\n\n*Tests du log rank*  \n\nOn va comparer les fonctions de survie pour la variable *surgery*. \n\n\n\n\n```{r eval=FALSE}\nsts graph, by(surgery)\n```\n\n\n\n![](images/Image9.png)\n\nTests du log rank: fonction **`sts test`**. On affichera ici plusieurs variantes du test.\n\n\n\n```{r eval=FALSE}\nlocal test `\" \"l\" \"w\" \"tw\" \"p\" \"'\nforeach test2 of local test {\nsts test surgery, `test2'\n}\n\n/*\nLog-rank test for equality of survivor functions\n\n        |   Events         Events\nsurgery |  observed       expected\n--------+-------------------------\n0       |        69          60.34\n1       |         6          14.66\n--------+-------------------------\nTotal   |        75          75.00\n\n              chi2(1) =       6.59\n              Pr>chi2 =     0.0103\n\n         failure _d:  died\n   analysis time _t:  stime\n\n\nWilcoxon (Breslow) test for equality of survivor functions\n\n        |   Events         Events        Sum of\nsurgery |  observed       expected        ranks\n--------+--------------------------------------\n0       |        69          60.34          623\n1       |         6          14.66         -623\n--------+--------------------------------------\nTotal   |        75          75.00            0\n\n              chi2(1) =       8.99\n              Pr>chi2 =     0.0027\n\n         failure _d:  died\n   analysis time _t:  stime\n\n\nTarone-Ware test for equality of survivor functions\n\n        |   Events         Events        Sum of\nsurgery |  observed       expected        ranks\n--------+--------------------------------------\n0       |        69          60.34    73.105398\n1       |         6          14.66   -73.105398\n--------+--------------------------------------\nTotal   |        75          75.00            0\n\n              chi2(1) =       8.46\n              Pr>chi2 =     0.0036\n\n         failure _d:  died\n   analysis time _t:  stime\n\n\nPeto-Peto test for equality of survivor functions\n\n        |   Events         Events        Sum of\nsurgery |  observed       expected        ranks\n--------+--------------------------------------\n0       |        69          60.34    6.0505875\n1       |         6          14.66   -6.0505875\n--------+--------------------------------------\nTotal   |        75          75.00            0\n\n              chi2(1) =       8.66\n              Pr>chi2 =     0.0032\n*/\n```\n\n\n\n\n*Comparaison des rmst*  \n\n\nInstallation de la commande strmst2:  \n\n\n```{r eval=FALSE}\nssc install strmst2\n```\n\n\n\n\narm1 = opération  \narm0 = pas d'opération  \n\n\n\n```{r eval=FALSE}\n\nstrmst2 surgery\n\n\n/*\nRestricted Mean Survival Time (RMST) by arm\n-----------------------------------------------------------\n   Group |  Estimate    Std. Err.      [95% Conf. Interval]\n---------+-------------------------------------------------\n   arm 1 |   734.758     133.478      473.145      996.370\n   arm 0 |   310.168      43.160      225.576      394.760\n-----------------------------------------------------------\n\nBetween-group contrast (arm 1 versus arm 0) \n------------------------------------------------------------------------\n           Contrast  |  Estimate       [95% Conf. Interval]     P>|z|\n---------------------+--------------------------------------------------\nRMST (arm 1 - arm 0) |   424.590      149.641      699.539      0.002\nRMST (arm 1 / arm 0) |     2.369        1.513        3.710      0.000\n------------------------------------------------------------------------\n*/\n\n```\n\n\n\n\n\n## Risques proportionnels\n\n### Modèle de Cox\n\n#### Estimation du modèle\n\nAvec la correction d'Efron\n\n\n\n```{r eval=FALSE}\n\nstcox year age surgery, nolog noshow efron\n\n/*\nCox regression -- Efron method for ties\n\nNo. of subjects =          103                  Number of obs    =         103\nNo. of failures =           75\nTime at risk    =        31938\n                                                LR chi2(3)       =       17.63\nLog likelihood  =   -289.30639                  Prob > chi2      =      0.0005\n\n------------------------------------------------------------------------------\n          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]\n-------------+----------------------------------------------------------------\n        year |     0.8872     0.0597    -1.78   0.076       0.7775      1.0124\n         age |     1.0300     0.0139     2.19   0.029       1.0031      1.0577\n     surgery |     0.3726     0.1625    -2.26   0.024       0.1584      0.8761\n------------------------------------------------------------------------------\n*/\n```\n\n```{r eval=FALSE}\n\nstcox year age surgery, nolog noshow efron nohr\n\n/*\nCox regression -- Efron method for ties\n\nNo. of subjects =          103                  Number of obs    =         103\nNo. of failures =           75\nTime at risk    =        31938\n                                                LR chi2(3)       =       17.63\nLog likelihood  =   -289.30639                  Prob > chi2      =      0.0005\n\n------------------------------------------------------------------------------\n          _t |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]\n-------------+----------------------------------------------------------------\n        year |    -0.1196     0.0673    -1.78   0.076      -0.2516      0.0124\n         age |     0.0296     0.0135     2.19   0.029       0.0031      0.0561\n     surgery |    -0.9873     0.4363    -2.26   0.024      -1.8424     -0.1323\n------------------------------------------------------------------------------\n*/\n```\n\n\n\n#### Test de l'hypothèse PH\n\n**Test Grambsch-Therneau sur les résidus de Schoenfeld**\n\n\n\n\n```{r eval=FALSE}\n\n* f(t)=t - par défaut \n\n\nestat phtest, detail\n\n\n/*\n      Test of proportional-hazards assumption\n\n      Time:  Time\n      ----------------------------------------------------------------\n                  |       rho            chi2       df       Prob>chi2\n      ------------+---------------------------------------------------\n      year        |      0.10162         0.80        1         0.3720\n      age         |      0.12937         1.61        1         0.2043\n      surgery     |      0.29664         5.54        1         0.0186\n      ------------+---------------------------------------------------\n      global test |                      8.76        3         0.0327\n      ----------------------------------------------------------------\n*/\n\n\n* f(t)= 1-km - solution par défaut de R\n      \nestat phtest, detail km\n\n/*\n      Test of proportional-hazards assumption\n\n      Time:  Kaplan-Meier\n      ----------------------------------------------------------------\n                  |       rho            chi2       df       Prob>chi2\n      ------------+---------------------------------------------------\n      year        |      0.15920         1.96        1         0.1620\n      age         |      0.10907         1.15        1         0.2845\n      surgery     |      0.25096         3.96        1         0.0465\n      ------------+---------------------------------------------------\n      global test |                      7.99        3         0.0462\n      ----------------------------------------------------------------\n*/\n\n```\n\n\n\n**Intéraction avec une fonction de la durée**\n\n$f(t)=t$\n\n\n\n```{r eval=FALSE}\nstcox year age surgery, nolog noshow efron nohr tvc(surgery) texp(_t)\n\n/*\nCox regression -- Efron method for ties\n\nNo. of subjects =          103                  Number of obs    =         103\nNo. of failures =           75\nTime at risk    =        31938\n                                                LR chi2(4)       =       21.58\nLog likelihood  =   -287.32903                  Prob > chi2      =      0.0002\n\n------------------------------------------------------------------------------\n          _t |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]\n-------------+----------------------------------------------------------------\nmain         |\n        year |    -0.1231     0.0668    -1.84   0.066      -0.2541      0.0079\n         age |     0.0289     0.0134     2.15   0.032       0.0025      0.0552\n     surgery |    -1.7547     0.6744    -2.60   0.009      -3.0765     -0.4330\n-------------+----------------------------------------------------------------\ntvc          |\n     surgery |     0.0022     0.0011     2.02   0.043       0.0001      0.0044\n------------------------------------------------------------------------------\nNote: Variables in tvc equation interacted with _t.\n*/\n\n\n\n```\n\n\n\n#### Introduction d'une variable dynamique (binaire)\n\n**Transformation de la base en format long aux temps d'évènement**  \n<br>\n\n*Etape 1*\n\n\n```{r eval=FALSE}\n\nstset stime, f(died) id(id)\n\n/*\n                id:  id\n     failure event:  died != 0 & died < .\nobs. time interval:  (stime[_n-1], stime]\n exit on or before:  failure\n\n------------------------------------------------------------------------------\n        103  total observations\n          0  exclusions\n------------------------------------------------------------------------------\n        103  observations remaining, representing\n        103  subjects\n         75  failures in single-failure-per-subject data\n     31,938  total analysis time at risk and under observation\n                                                at risk from t =         0\n                                     earliest observed entry t =         0\n                                          last observed exit t =     1,799\n\n*/\n```\n\n\n\n*Etape 2*\n\n\n```{r eval=FALSE}\nstsplit, at(failure)\n\nstset stime, f(died) id(id)\n\nsort id _t\nlist in 1/23\n\n\n/*\n                id:  id\n     failure event:  died != 0 & died < .\nobs. time interval:  (stime[_n-1], stime]\n exit on or before:  failure\n\n------------------------------------------------------------------------------\n        105  total observations\n          2  ignored because id missing\n------------------------------------------------------------------------------\n        103  observations remaining, representing\n        103  subjects\n         75  failures in single-failure-per-subject data\n     31,938  total analysis time at risk and under observation\n                                                at risk from t =         0\n                                     earliest observed entry t =         0\n                                          last observed exit t =     1,799\n\n     +--------------------------------------------------------------------------------------------------+\n     | id   year   age   died   stime   surgery   transp~t   wait   mois   compet   _st   _d   _t   _t0 |\n     |--------------------------------------------------------------------------------------------------|\n  1. |  1     67    30      .       1         0          0      0      2        1     1    0    1     0 |\n  2. |  1     67    30      .       2         0          0      0      2        1     1    0    2     1 |\n  3. |  1     67    30      .       3         0          0      0      2        1     1    0    3     2 |\n  4. |  1     67    30      .       5         0          0      0      2        1     1    0    5     3 |\n  5. |  1     67    30      .       6         0          0      0      2        1     1    0    6     5 |\n     |--------------------------------------------------------------------------------------------------|\n  6. |  1     67    30      .       8         0          0      0      2        1     1    0    8     6 |\n  7. |  1     67    30      .       9         0          0      0      2        1     1    0    9     8 |\n  8. |  1     67    30      .      12         0          0      0      2        1     1    0   12     9 |\n  9. |  1     67    30      .      16         0          0      0      2        1     1    0   16    12 |\n 10. |  1     67    30      .      17         0          0      0      2        1     1    0   17    16 |\n     |--------------------------------------------------------------------------------------------------|\n 11. |  1     67    30      .      18         0          0      0      2        1     1    0   18    17 |\n 12. |  1     67    30      .      21         0          0      0      2        1     1    0   21    18 |\n 13. |  1     67    30      .      28         0          0      0      2        1     1    0   28    21 |\n 14. |  1     67    30      .      30         0          0      0      2        1     1    0   30    28 |\n 15. |  1     67    30      .      32         0          0      0      2        1     1    0   32    30 |\n     |--------------------------------------------------------------------------------------------------|\n 16. |  1     67    30      .      35         0          0      0      2        1     1    0   35    32 |\n 17. |  1     67    30      .      36         0          0      0      2        1     1    0   36    35 |\n 18. |  1     67    30      .      37         0          0      0      2        1     1    0   37    36 |\n 19. |  1     67    30      .      39         0          0      0      2        1     1    0   39    37 |\n 20. |  1     67    30      .      40         0          0      0      2        1     1    0   40    39 |\n     |--------------------------------------------------------------------------------------------------|\n 21. |  1     67    30      .      43         0          0      0      2        1     1    0   43    40 |\n 22. |  1     67    30      .      45         0          0      0      2        1     1    0   45    43 |\n 23. |  1     67    30      1      50         0          0      0      2        1     1    1   50    45 |\n     +--------------------------------------------------------------------------------------------------+\n*/\n```\n\n\n\n*Etape 3*\n\n\n```{r eval=FALSE}\ngen tvc = transplant==1 & wait<=_t\nsort id _t\nlist id transplant wait tvc _d _t _t0 if id==10  , noobs\n\n/*\n  +--------------------------------------------+\n  | id   transp~t   wait   tvc   _d   _t   _t0 |\n  |--------------------------------------------|\n  | 10          1     12     0    0    1     0 |\n  | 10          1     12     0    0    2     1 |\n  | 10          1     12     0    0    3     2 |\n  | 10          1     12     0    0    5     3 |\n  | 10          1     12     0    0    6     5 |\n  |--------------------------------------------|\n  | 10          1     12     0    0    8     6 |\n  | 10          1     12     0    0    9     8 |\n  | 10          1     12     1    0   12     9 |\n  | 10          1     12     1    0   16    12 |\n  | 10          1     12     1    0   17    16 |\n  |--------------------------------------------|\n  | 10          1     12     1    0   18    17 |\n  | 10          1     12     1    0   21    18 |\n  | 10          1     12     1    0   28    21 |\n  | 10          1     12     1    0   30    28 |\n  | 10          1     12     1    0   32    30 |\n  |--------------------------------------------|\n  | 10          1     12     1    0   35    32 |\n  | 10          1     12     1    0   36    35 |\n  | 10          1     12     1    0   37    36 |\n  | 10          1     12     1    0   39    37 |\n  | 10          1     12     1    0   40    39 |\n  |--------------------------------------------|\n  | 10          1     12     1    0   43    40 |\n  | 10          1     12     1    0   45    43 |\n  | 10          1     12     1    0   50    45 |\n  | 10          1     12     1    0   51    50 |\n  | 10          1     12     1    0   53    51 |\n  |--------------------------------------------|\n  | 10          1     12     1    1   58    53 |\n  +--------------------------------------------+\n*/\n```\n\n\n\n**Estimation du modèle**  \n\n\n\n```{r eval=FALSE}\nstcox year age surgery tvc, nolog noshow efron nohr\n\nCox regression -- Efron method for ties\n\nNo. of subjects =          103                  Number of obs    =       3,573\nNo. of failures =           75\nTime at risk    =        31938\n                                                LR chi2(4)       =       17.70\nLog likelihood  =   -289.27014                  Prob > chi2      =      0.0014\n\n------------------------------------------------------------------------------\n          _t |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]\n-------------+----------------------------------------------------------------\n        year |    -0.1203     0.0673    -1.79   0.074      -0.2523      0.0117\n         age |     0.0304     0.0139     2.19   0.029       0.0032      0.0577\n     surgery |    -0.9829     0.4366    -2.25   0.024      -1.8385     -0.1273\n         tvc |    -0.0822     0.3048    -0.27   0.787      -0.6797      0.5153\n------------------------------------------------------------------------------\n```\n\n\n\n### Modèle  à temps discret\n\nVariable de durée = *mois*\n\n#### Mise en forme de la base\n\n\n\n```{r eval=FALSE}\n\nexpand mois\nbysort id: gen t=_n\ngen e = died\nreplace e=0 if t<mois\n\n* list in 1/31\n\n/*\n\n     +-------------------------------------------------------------------------------------+\n     | id   year   age   died   stime   surgery   transp~t   wait   mois   compet    t   e |\n     |-------------------------------------------------------------------------------------|\n  1. |  1     67    30      1      50         0          0      0      2        1    1   0 |\n  2. |  1     67    30      1      50         0          0      0      2        1    2   1 |\n  3. |  2     68    51      1       6         0          0      0      1        1    1   1 |\n  4. |  3     68    54      1      16         0          1      1      1        1    1   1 |\n  5. |  4     68    40      1      39         0          1     36      2        2    1   0 |\n     |-------------------------------------------------------------------------------------|\n  6. |  4     68    40      1      39         0          1     36      2        2    2   1 |\n  7. |  5     68    20      1      18         0          0      0      1        1    1   1 |\n  8. |  6     68    54      1       3         0          0      0      1        2    1   1 |\n  9. |  7     68    50      1     675         0          1     51     23        1    1   0 |\n 10. |  7     68    50      1     675         0          1     51     23        1    2   0 |\n     |-------------------------------------------------------------------------------------|\n 11. |  7     68    50      1     675         0          1     51     23        1    3   0 |\n 12. |  7     68    50      1     675         0          1     51     23        1    4   0 |\n 13. |  7     68    50      1     675         0          1     51     23        1    5   0 |\n 14. |  7     68    50      1     675         0          1     51     23        1    6   0 |\n 15. |  7     68    50      1     675         0          1     51     23        1    7   0 |\n     |-------------------------------------------------------------------------------------|\n 16. |  7     68    50      1     675         0          1     51     23        1    8   0 |\n 17. |  7     68    50      1     675         0          1     51     23        1    9   0 |\n 18. |  7     68    50      1     675         0          1     51     23        1   10   0 |\n 19. |  7     68    50      1     675         0          1     51     23        1   11   0 |\n 20. |  7     68    50      1     675         0          1     51     23        1   12   0 |\n     |-------------------------------------------------------------------------------------|\n 21. |  7     68    50      1     675         0          1     51     23        1   13   0 |\n 22. |  7     68    50      1     675         0          1     51     23        1   14   0 |\n 23. |  7     68    50      1     675         0          1     51     23        1   15   0 |\n 24. |  7     68    50      1     675         0          1     51     23        1   16   0 |\n 25. |  7     68    50      1     675         0          1     51     23        1   17   0 |\n     |-------------------------------------------------------------------------------------|\n 26. |  7     68    50      1     675         0          1     51     23        1   18   0 |\n 27. |  7     68    50      1     675         0          1     51     23        1   19   0 |\n 28. |  7     68    50      1     675         0          1     51     23        1   20   0 |\n 29. |  7     68    50      1     675         0          1     51     23        1   21   0 |\n 30. |  7     68    50      1     675         0          1     51     23        1   22   0 |\n     |-------------------------------------------------------------------------------------|\n 31. |  7     68    50      1     675         0          1     51     23        1   23   1 |\n     +-------------------------------------------------------------------------------------+\n\n*/\n```\n\n\n\n\n#### Paramétrisation avec durée quantitative\n\nLes critères d'information \n\n\n\n```{r eval=FALSE}\n\ngen t2=t^2\ngen t3=t^3\n\nlogit e  t ,  nolog \nestat ic\n\nlogit e  t t2 ,  nolog \nestat ic\n\nlogit e  t2 t3 ,  nolog \nestat ic\n\n\n\nLogistic regression                             Number of obs     =      1,127\n                                                LR chi2(1)        =      50.85\n                                                Prob > chi2       =     0.0000\nLog likelihood = -250.26058                     Pseudo R2         =     0.0922\n\n------------------------------------------------------------------------------\n           e |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]\n-------------+----------------------------------------------------------------\n           t |    -0.1007     0.0185    -5.45   0.000      -0.1370     -0.0645\n       _cons |    -1.6436     0.1724    -9.53   0.000      -1.9815     -1.3057\n------------------------------------------------------------------------------\n\n\nAkaike's information criterion and Bayesian information criterion\n\n-----------------------------------------------------------------------------\n       Model |          N   ll(null)  ll(model)      df        AIC        BIC\n-------------+---------------------------------------------------------------\n           . |      1,127  -275.6841  -250.2606       2   504.5212   514.5758\n-----------------------------------------------------------------------------\nNote: BIC uses N = number of observations. See [R] BIC note.\n\n*****************************************************************************\n\nLogistic regression                             Number of obs     =      1,127\n                                                LR chi2(2)        =      65.25\n                                                Prob > chi2       =     0.0000\nLog likelihood = -243.05761                     Pseudo R2         =     0.1183\n\n------------------------------------------------------------------------------\n           e |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]\n-------------+----------------------------------------------------------------\n           t |    -0.2172     0.0357    -6.08   0.000      -0.2872     -0.1471\n          t2 |     0.0034     0.0008     4.50   0.000       0.0019      0.0049\n       _cons |    -1.2326     0.1925    -6.40   0.000      -1.6098     -0.8554\n------------------------------------------------------------------------------\n\n\nAkaike's information criterion and Bayesian information criterion\n\n-----------------------------------------------------------------------------\n       Model |          N   ll(null)  ll(model)      df        AIC        BIC\n-------------+---------------------------------------------------------------\n           . |      1,127  -275.6841  -243.0576       3   492.1152   507.1972\n-----------------------------------------------------------------------------\nNote: BIC uses N = number of observations. See [R] BIC note.\n\n       \n*****************************************************************************       \n\nLogistic regression                             Number of obs     =      1,127\n                                                LR chi2(3)        =      72.86\n                                                Prob > chi2       =     0.0000\nLog likelihood = -239.25267                     Pseudo R2         =     0.1321\n\n------------------------------------------------------------------------------\n           e |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]\n-------------+----------------------------------------------------------------\n           t |    -0.4038     0.0819    -4.93   0.000      -0.5643     -0.2434\n          t2 |     0.0157     0.0050     3.14   0.002       0.0059      0.0254\n          t3 |    -0.0002     0.0001    -2.31   0.021      -0.0003     -0.0000\n       _cons |    -0.8250     0.2406    -3.43   0.001      -1.2965     -0.3536\n------------------------------------------------------------------------------\n\nAkaike's information criterion and Bayesian information criterion\n\n-----------------------------------------------------------------------------\n       Model |          N   ll(null)  ll(model)      df        AIC        BIC\n-------------+---------------------------------------------------------------\n           . |      1,127  -275.6841  -239.2527       4   486.5053   506.6146\n-----------------------------------------------------------------------------\nNote: BIC uses N = number of observations. See [R] BIC note.\n\n```\n\n\n\n\n**Estimation du modèle**\n\n\n\n```{r eval=FALSE}\n\nlogit e  t t2 t3 year age surgery, nolog\n\n/*\n\nLogistic regression                             Number of obs     =      1,127\n                                                LR chi2(6)        =      90.69\n                                                Prob > chi2       =     0.0000\nLog likelihood = -230.33671                     Pseudo R2         =     0.1645\n\n------------------------------------------------------------------------------\n           e |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]\n-------------+----------------------------------------------------------------\n           t |    -0.3721     0.0824    -4.52   0.000      -0.5335     -0.2106\n          t2 |     0.0142     0.0050     2.83   0.005       0.0044      0.0241\n          t3 |    -0.0002     0.0001    -2.11   0.035      -0.0003     -0.0000\n        year |    -0.1327     0.0738    -1.80   0.072      -0.2773      0.0119\n         age |     0.0333     0.0147     2.27   0.023       0.0046      0.0621\n     surgery |    -1.0109     0.4486    -2.25   0.024      -1.8902     -0.1317\n       _cons |     7.0827     5.3077     1.33   0.182      -3.3203     17.4856\n------------------------------------------------------------------------------\n*/\n```\n\n\n\n\n### Paramétrisation avec durée discrète\n\nPour l'exemple seulement, on prendra des intervalles découpés sur les quartiles de la durée\n\n\n\n```{r eval=FALSE}\n\nxtile ct4=t, n(4)\nbysort id ct4: keep if _n==_N\n\ntab  ct4 e\n\nlogit e i.ct4  year age surgery,  nolog\n\n/*\n\n\n         4 |\n quantiles |           e\n      of t |         0          1 |     Total\n-----------+----------------------+----------\n         1 |        50         53 |       103 \n         2 |        35         11 |        46 \n         3 |        27          5 |        32 \n         4 |        10          6 |        16 \n-----------+----------------------+----------\n     Total |       122         75 |       197 \n\n\n\nLogistic regression                             Number of obs     =        197\n                                                LR chi2(6)        =      39.30\n                                                Prob > chi2       =     0.0000\nLog likelihood = -111.23965                     Pseudo R2         =     0.1501\n\n------------------------------------------------------------------------------\n           e |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]\n-------------+----------------------------------------------------------------\n         ct4 |\n          2  |    -1.0334     0.4189    -2.47   0.014      -1.8543     -0.2124\n          3  |    -1.6152     0.5449    -2.96   0.003      -2.6831     -0.5473\n          4  |    -0.4789     0.5993    -0.80   0.424      -1.6535      0.6957\n             |\n        year |    -0.2032     0.0932    -2.18   0.029      -0.3859     -0.0206\n         age |     0.0469     0.0185     2.53   0.011       0.0106      0.0831\n     surgery |    -1.1102     0.5026    -2.21   0.027      -2.0952     -0.1252\n       _cons |    12.4467     6.6537     1.87   0.061      -0.5943     25.4877\n------------------------------------------------------------------------------\n*/\n```\n\n\n\n\n## Modèles paramétriques\n\nCommande ```streg```\n\n### Modèle AFT\n\n**Weibull**\n\nPar défaut, le modèle de Weibull est exécuté sous paramétrisation PH. Pour une paramétrisation type AFT, ajouter l'option *time*.\n\n\n\n```{r eval=FALSE}\n\nwebuse set \"https://raw.githubusercontent.com//mthevenin/analyse_duree/master/bases/\"\nwebuse  \"transplantation_m\", clear\nwebuse set\n\nstset stime, f(died)\nstreg year age surgery , dist(weibull) time nolog noshow\nestat ic\n\n/*\n\nWeibull AFT regression\n\nNo. of subjects =          103                  Number of obs    =         103\nNo. of failures =           75\nTime at risk    =        31938\n                                                LR chi2(3)       =       18.87\nLog likelihood  =    -188.6278                  Prob > chi2      =      0.0003\n\n------------------------------------------------------------------------------\n          _t |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]\n-------------+----------------------------------------------------------------\n        year |     0.1620     0.1218     1.33   0.184      -0.0768      0.4008\n         age |    -0.0615     0.0247    -2.49   0.013      -0.1100     -0.0130\n     surgery |     1.9703     0.7794     2.53   0.011       0.4427      3.4980\n       _cons |    -3.0220     8.7284    -0.35   0.729     -20.1294     14.0854\n-------------+----------------------------------------------------------------\n       /ln_p |    -0.5868     0.0927    -6.33   0.000      -0.7685     -0.4051\n-------------+----------------------------------------------------------------\n           p |     0.5561     0.0516                        0.4637      0.6669\n         1/p |     1.7983     0.1667                        1.4995      2.1566\n------------------------------------------------------------------------------\n\nAkaike's information criterion and Bayesian information criterion\n\n-----------------------------------------------------------------------------\n       Model |          N   ll(null)  ll(model)      df        AIC        BIC\n-------------+---------------------------------------------------------------\n           . |        103  -198.0632  -188.6278       5   387.2556   400.4292\n-----------------------------------------------------------------------------\nNote: BIC uses N = number of observations. See [R] BIC note.\n\n*/\n```\n\n\n\n**Log-logistique**\n\n\n\n```{r eval=FALSE}\n\nstreg year age surgery , dist(loglog) nolog noshow \nestat ic\n\n/*\nLoglogistic AFT regression\n\nNo. of subjects =          103                  Number of obs    =         103\nNo. of failures =           75\nTime at risk    =        31938\n                                                LR chi2(3)       =       21.69\nLog likelihood  =   -183.03937                  Prob > chi2      =      0.0001\n\n------------------------------------------------------------------------------\n          _t |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]\n-------------+----------------------------------------------------------------\n        year |     0.2408     0.1172     2.05   0.040       0.0110      0.4705\n         age |    -0.0427     0.0213    -2.00   0.045      -0.0845     -0.0010\n     surgery |     2.2747     0.6913     3.29   0.001       0.9198      3.6296\n       _cons |   -10.4034     8.3410    -1.25   0.212     -26.7515      5.9446\n-------------+----------------------------------------------------------------\n    /lngamma |     0.1805     0.0970     1.86   0.063      -0.0095      0.3706\n-------------+----------------------------------------------------------------\n       gamma |     1.1979     0.1161                        0.9906      1.4486\n------------------------------------------------------------------------------\n\n\nAkaike's information criterion and Bayesian information criterion\n\n-----------------------------------------------------------------------------\n       Model |          N   ll(null)  ll(model)      df        AIC        BIC\n-------------+---------------------------------------------------------------\n           . |        103  -193.8865  -183.0394       5   376.0787   389.2524\n-----------------------------------------------------------------------------\n*/\n```\n\n\n\n\n## Risques concurrents\n\n## Non paramétrique: estimation des IC\n\nInstaller les commandes ```stcompet``` et ```stcomlist``` \n\n\n\n\n```{r eval=FALSE}\nssc install stcompet\nssc install stcomlist\n```\n\n\n\nLe risque d'intérêt est compet=1, le risque concurrent est compet=2\n \n\n\n```{r eval=FALSE}\nstset stime, failure(compet==1)\nstcomlist, compet1(2)\n\n/*\n            failure:  compet == 1\n competing failures:  compet == 2\n\n    Time       CIF         SE     [95% Conf. Int.]\n--------------------------------------------------\n       1    0.0097     0.0097     0.0009    0.0477\n       2    0.0388     0.0190     0.0127    0.0892\n       3    0.0583     0.0231     0.0239    0.1149\n       5    0.0777     0.0264     0.0363    0.1395\n       6    0.0874     0.0278     0.0429    0.1515\n       8    0.0971     0.0292     0.0497    0.1634\n       9    0.1068     0.0304     0.0566    0.1751\n      12    0.1166     0.0316     0.0638    0.1868\n      16    0.1362     0.0338     0.0785    0.2099\n      18    0.1461     0.0349     0.0860    0.2212\n      21    0.1657     0.0367     0.1014    0.2437\n      32    0.1756     0.0376     0.1093    0.2550\n      37    0.1856     0.0384     0.1173    0.2662\n      40    0.1957     0.0393     0.1254    0.2775\n      43    0.2058     0.0400     0.1337    0.2888\n      45    0.2158     0.0408     0.1420    0.2999\n      50    0.2259     0.0415     0.1503    0.3110\n      51    0.2360     0.0422     0.1588    0.3221\n      53    0.2461     0.0428     0.1673    0.3330\n      58    0.2562     0.0434     0.1759    0.3439\n      61    0.2662     0.0440     0.1845    0.3548\n      66    0.2763     0.0445     0.1932    0.3656\n      69    0.2864     0.0450     0.2020    0.3763\n      72    0.3066     0.0459     0.2197    0.3976\n      77    0.3167     0.0464     0.2286    0.4082\n      78    0.3267     0.0467     0.2376    0.4187\n      81    0.3368     0.0471     0.2466    0.4292\n      85    0.3469     0.0475     0.2556    0.4396\n      90    0.3570     0.0478     0.2648    0.4500\n      96    0.3671     0.0481     0.2739    0.4604\n     102    0.3771     0.0484     0.2831    0.4707\n     110    0.3874     0.0487     0.2925    0.4812\n     149    0.3980     0.0489     0.3021    0.4920\n     165    0.4085     0.0492     0.3118    0.5027\n     186    0.4193     0.0495     0.3217    0.5137\n     188    0.4301     0.0497     0.3316    0.5246\n     207    0.4408     0.0499     0.3417    0.5354\n     219    0.4516     0.0501     0.3517    0.5462\n     263    0.4624     0.0502     0.3618    0.5570\n     285    0.4846     0.0505     0.3826    0.5791\n     308    0.4957     0.0506     0.3931    0.5900\n     340    0.5068     0.0507     0.4037    0.6009\n     583    0.5221     0.0514     0.4171    0.6168\n     675    0.5401     0.0524     0.4322    0.6361\n     733    0.5580     0.0532     0.4477    0.6548\n     995    0.5808     0.0548     0.4659    0.6795\n    1032    0.6036     0.0559     0.4851    0.7031\n    1386    0.6340     0.0583     0.5083    0.7357\n\n\n            failure:  compet == 2\n competing failures:  compet == 1\n\n    Time       CIF         SE     [95% Conf. Int.]\n--------------------------------------------------\n       3    0.0097     0.0097     0.0009    0.0477\n       6    0.0194     0.0136     0.0038    0.0619\n      16    0.0292     0.0166     0.0079    0.0761\n      17    0.0391     0.0191     0.0128    0.0897\n      28    0.0489     0.0213     0.0182    0.1029\n      30    0.0587     0.0232     0.0240    0.1157\n      35    0.0686     0.0250     0.0302    0.1286\n      36    0.0786     0.0267     0.0367    0.1411\n      39    0.0885     0.0282     0.0435    0.1534\n      40    0.0986     0.0296     0.0504    0.1658\n      68    0.1188     0.0322     0.0650    0.1901\n      80    0.1288     0.0334     0.0724    0.2020\n     100    0.1389     0.0345     0.0800    0.2138\n     153    0.1495     0.0356     0.0880    0.2261\n     334    0.1605     0.0368     0.0964    0.2392\n     342    0.1720     0.0381     0.1052    0.2526\n     852    0.1913     0.0417     0.1175    0.2787\n     979    0.2141     0.0460     0.1320    0.3094\n*/\n```\n\n\n\n\n### Modèle cause-specific (Cox)\n\nAttention: non relié aux IC\n\n\n\n```{r eval=FALSE}\n\nstcox year age surgery,  nohr\n\n/*\nIteration 0:   log likelihood = -222.40766\nIteration 1:   log likelihood = -214.66912\nIteration 2:   log likelihood = -214.47069\nIteration 3:   log likelihood = -214.46905\nIteration 4:   log likelihood = -214.46905\nRefining estimates:\nIteration 0:   log likelihood = -214.46905\n\nCox regression -- Breslow method for ties\n\nNo. of subjects =          103                  Number of obs    =         103\nNo. of failures =           56\nTime at risk    =        31938\n                                                LR chi2(3)       =       15.88\nLog likelihood  =   -214.46905                  Prob > chi2      =      0.0012\n\n------------------------------------------------------------------------------\n          _t |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]\n-------------+----------------------------------------------------------------\n        year |    -0.1033     0.0774    -1.33   0.182      -0.2550      0.0485\n         age |     0.0385     0.0163     2.36   0.018       0.0065      0.0704\n     surgery |    -1.1099     0.5290    -2.10   0.036      -2.1468     -0.0730\n------------------------------------------------------------------------------\n*/\n```\n\n\n\n\n### Modèle de Fine-Gray\n\nLa commande *`stcrreg`* est installée avec les commandes de base.\nRelié directement aux IC, la définition du risque diffère du risque instantané usuel (risque de sous répartition).\n\n\n\n```{r eval=FALSE}\nstcrreg year age surgery, compete(compet=2) nohr\n\n\n/*\n         failure _d:  compet == 1\n   analysis time _t:  stime\n\nIteration 0:   log pseudolikelihood = -227.92407  \nIteration 1:   log pseudolikelihood = -227.69764  \nIteration 2:   log pseudolikelihood = -227.69531  \nIteration 3:   log pseudolikelihood = -227.69531  \n\nCompeting-risks regression                       No. of obs       =        103\n                                                 No. of subjects  =        103\nFailure event  : compet == 1                     No. failed       =         56\nCompeting event: compet == 2                     No. competing    =         19\n                                                 No. censored     =         28\n\n                                                 Wald chi2(3)     =      11.42\nLog pseudolikelihood = -227.69531                Prob > chi2      =     0.0097\n\n------------------------------------------------------------------------------\n             |               Robust\n          _t |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]\n-------------+----------------------------------------------------------------\n        year |    -0.0724     0.0716    -1.01   0.312      -0.2128      0.0679\n         age |     0.0370     0.0177     2.09   0.037       0.0022      0.0718\n     surgery |    -0.8688     0.4510    -1.93   0.054      -1.7528      0.0153\n------------------------------------------------------------------------------\n\n       */\n```\n\n\n\n### Modèle logistique multinomial\n\nAttention: non relié aux IC\nPour la variable de durée on utilise la variable *mois*\n\n\n\n```{r eval=FALSE}\nexpand mois\nbysort id: gen t=_n\ngen t2=t*t\n\ngen e = compet\nreplace e=0 if t<mois\nmlogit e t t2 year age surgery\n\n/*\nIteration 0:   log likelihood = -318.13171  \nIteration 1:   log likelihood = -285.78811  \nIteration 2:   log likelihood = -275.20206  \nIteration 3:   log likelihood = -275.00574  \nIteration 4:   log likelihood = -275.00542  \nIteration 5:   log likelihood = -275.00542  \n\nMultinomial logistic regression                 Number of obs     =      1,127\n                                                LR chi2(10)       =      86.25\n                                                Prob > chi2       =     0.0000\nLog likelihood = -275.00542                     Pseudo R2         =     0.1356\n\n------------------------------------------------------------------------------\n           e |        RRR   Std. Err.      z    P>|z|     [95% Conf. Interval]\n-------------+----------------------------------------------------------------\n0            |  (base outcome)\n-------------+----------------------------------------------------------------\n1            |\n           t |     0.8159     0.0338    -4.91   0.000       0.7522      0.8850\n          t2 |     1.0032     0.0009     3.53   0.000       1.0014      1.0049\n        year |     0.8795     0.0718    -1.57   0.116       0.7494      1.0321\n         age |     1.0449     0.0183     2.51   0.012       1.0097      1.0813\n     surgery |     0.3175     0.1711    -2.13   0.033       0.1104      0.9129\n* Constante non reportée     \n-------------+----------------------------------------------------------------\n2            |\n           t |     0.8168     0.0565    -2.93   0.003       0.7134      0.9353\n          t2 |     1.0030     0.0015     1.94   0.052       1.0000      1.0060\n        year |     0.8158     0.1127    -1.47   0.141       0.6223      1.0695\n         age |     1.0111     0.0248     0.45   0.654       0.9635      1.0610\n     surgery |     0.5412     0.4221    -0.79   0.431       0.1173      2.4959\n* Constante non reportée      \n------------------------------------------------------------------------------\n\n       */\n```\n\n",
    "supporting": [
      "14-Stata_files\\figure-pdf"
    ],
    "filters": []
  }
}