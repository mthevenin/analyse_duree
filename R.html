<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.38">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Stata.html" rel="next">
<link href="./frailty.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"><strong>ANALYSE DES DUREES 2022</strong></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/mthevenin/analyse_duree"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:marc.thevenin@ined.fr"><i class="bi bi-envelope" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">R</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false"><strong>Données et théorie</strong></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./introduction.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Donnees.html" class="sidebar-item-text sidebar-link">Les Données</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Theorie.html" class="sidebar-item-text sidebar-link">La théorie</a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false"><strong>Méthodes non paramétriques</strong></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fsurvie.html" class="sidebar-item-text sidebar-link">Les fonctions de survie</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./comp_fsurvie.html" class="sidebar-item-text sidebar-link">Tests de comparaison</a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false"><strong>Modèles à risques proportionnels</strong></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro_mod.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cox.html" class="sidebar-item-text sidebar-link">Modèle de Cox</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./discret.html" class="sidebar-item-text sidebar-link">Modèle temps discret</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dynamiques.html" class="sidebar-item-text sidebar-link">Variables dynamiques</a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false"><strong>Compléments</strong></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./parametrique.html" class="sidebar-item-text sidebar-link">Modèles paramétriques</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./concurrent.html" class="sidebar-item-text sidebar-link">Risques concurrents</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./frailty.html" class="sidebar-item-text sidebar-link">Fragilité et immunité</a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true"><strong>Programmation</strong></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./R.html" class="sidebar-item-text sidebar-link active">R</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Stata.html" class="sidebar-item-text sidebar-link">Stata</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Sas.html" class="sidebar-item-text sidebar-link">SAS</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Python.html" class="sidebar-item-text sidebar-link">PYTHON</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Sections</h2>
   
  <ul>
  <li><a href="#packages-utilisés-pour-lanalyse" id="toc-packages-utilisés-pour-lanalyse" class="nav-link active" data-scroll-target="#packages-utilisés-pour-lanalyse"><strong>Packages utilisés pour l’analyse</strong></a>
  <ul class="collapse">
  <li><a href="#installation" id="toc-installation" class="nav-link" data-scroll-target="#installation"><strong>Installation</strong></a></li>
  </ul></li>
  <li><a href="#survival-v2-versus-v3" id="toc-survival-v2-versus-v3" class="nav-link" data-scroll-target="#survival-v2-versus-v3"><strong>Survival v2 versus v3</strong></a></li>
  <li><a href="#analyse-non-paramétrique" id="toc-analyse-non-paramétrique" class="nav-link" data-scroll-target="#analyse-non-paramétrique"><strong>Analyse Non paramétrique</strong></a>
  <ul class="collapse">
  <li><a href="#méthode-actuarielle" id="toc-méthode-actuarielle" class="nav-link" data-scroll-target="#méthode-actuarielle"><strong>Méthode actuarielle</strong></a></li>
  <li><a href="#méthode-kaplan-meier" id="toc-méthode-kaplan-meier" class="nav-link" data-scroll-target="#méthode-kaplan-meier"><strong>Méthode Kaplan-Meier</strong></a></li>
  </ul></li>
  <li><a href="#modèle-de-cox" id="toc-modèle-de-cox" class="nav-link" data-scroll-target="#modèle-de-cox"><strong>Modèle de Cox</strong></a>
  <ul class="collapse">
  <li><a href="#estimation-du-modèle" id="toc-estimation-du-modèle" class="nav-link" data-scroll-target="#estimation-du-modèle"><strong>Estimation du modèle</strong></a></li>
  <li><a href="#hypothèse-ph" id="toc-hypothèse-ph" class="nav-link" data-scroll-target="#hypothèse-ph"><strong>Hypothèse PH</strong></a></li>
  <li><a href="#variable-dynamique-binaire" id="toc-variable-dynamique-binaire" class="nav-link" data-scroll-target="#variable-dynamique-binaire"><strong>Variable dynamique (binaire)</strong></a></li>
  </ul></li>
  <li><a href="#analyse-en-temps-discret" id="toc-analyse-en-temps-discret" class="nav-link" data-scroll-target="#analyse-en-temps-discret"><strong>Analyse en temps discret</strong></a>
  <ul class="collapse">
  <li><a href="#durée-continue" id="toc-durée-continue" class="nav-link" data-scroll-target="#durée-continue"><strong>Durée continue</strong></a></li>
  <li><a href="#durée-discrète" id="toc-durée-discrète" class="nav-link" data-scroll-target="#durée-discrète"><strong>Durée discrète</strong></a></li>
  </ul></li>
  <li><a href="#modèles-pusuels" id="toc-modèles-pusuels" class="nav-link" data-scroll-target="#modèles-pusuels"><strong>Modèles pusuels</strong></a>
  <ul class="collapse">
  <li><a href="#modèle-de-weibull" id="toc-modèle-de-weibull" class="nav-link" data-scroll-target="#modèle-de-weibull"><strong>Modèle de Weibull</strong></a></li>
  </ul></li>
  <li><a href="#risques-concurrents" id="toc-risques-concurrents" class="nav-link" data-scroll-target="#risques-concurrents"><strong>Risques concurrents</strong></a>
  <ul class="collapse">
  <li><a href="#incidences-cumulées" id="toc-incidences-cumulées" class="nav-link" data-scroll-target="#incidences-cumulées"><strong>Incidences cumulées</strong></a></li>
  <li><a href="#modèles" id="toc-modèles" class="nav-link" data-scroll-target="#modèles"><strong>Modèles</strong></a>
  <ul class="collapse">
  <li><a href="#fine-gray" id="toc-fine-gray" class="nav-link" data-scroll-target="#fine-gray">** Fine-Gray**</a></li>
  <li><a href="#modèle-multinomial" id="toc-modèle-multinomial" class="nav-link" data-scroll-target="#modèle-multinomial"><strong>Modèle multinomial</strong></a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">R</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<section id="packages-utilisés-pour-lanalyse" class="level1">
<h1><strong>Packages utilisés pour l’analyse</strong></h1>
<ul>
<li><em>Non Paramétrique</em>: <code>survival</code>, <code>discSurv</code>, <code>survRM2</code></li>
<li><em>Semi paramétrique, temps discret</em>: <code>survival</code>, fonction <code>uncount</code> (package <code>tydir</code>) , fonction <code>glm</code>, fonction <code>quantcut</code> (package <code>gtools</code>)</li>
<li><em>Paramétrique, Parmar Royston</em> (pour info, non traité): <code>survival</code> <code>flexsurv</code></li>
<li><em>Risques concurrents</em>: <code>cmprsk</code><br>
</li>
<li><em>Modèle cure (npour info, non traité)</em>: modèles mixtes <code>smcure</code>, modèles non mixtes <code>flexsurv</code></li>
</ul>
<p><br> <strong>Autres</strong>: <code>survminer</code>, <code>jtools</code>, <code>gtsummary</code> (+<code>RecordLinkage</code>) pour améliorer certains outputs (graphiques et résultats de régression).</p>
<section id="installation" class="level2">
<h2 class="anchored" data-anchor-id="installation"><strong>Installation</strong></h2>
<p>Les dernières versions de certains packages peuvent être installées via Github (ex: survminer). Pour les récupérer, passer par le package <code>devtools</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("survival")</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("survminer")</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("flexsurv")</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("survRM2")</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("tidyr")</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("gtools")</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("jtools")</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("miceadds")</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("RecordLinkage")</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("cmprsk")</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("tibble")</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("stringr")</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("gtsummary")</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(flexsurv)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survRM2)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gtools)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jtools)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RecordLinkage)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmprsk)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
</section>
</section>
<section id="survival-v2-versus-v3" class="level1">
<h1><strong>Survival v2 versus v3</strong></h1>
<p><strong>MAJ MAI 2022</strong></p>
<p><br> Se reporter à l’index ou à la partie sur les risques proportionnels.</p>
<p>Pour avoir des résultats cohérents avec les autres applications, j’ai conservé la version 2 de la librairie <code>survival</code>. J’ai donné une alternative au test avec une ancienne méthode, consistant à faire une régression linéaire entre les residus standardisés de Schoenfeld et une fonction de la durée, à ce jour limité à <span class="math inline">\(f(t)=t\)</span>. Le code n’est pas trop compliqué, manque juste la récupération des noms des variables. Ici ce n’est pas trop grave car il y a seulement 3 variables pour autant de degrés de liberté, mais cela risque de devenir un peu plus lourd pour un modèle plus riche.</p>
<p>Au cas où je donne les instructions pour installer la dernière mise à jour de la version 2 de survival (penser à désinstaller la v3 si nécessaire). La dernière version de <strong><code>Rtools</code></strong> doit être installée.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># installation survival 2.44-1 (30 mars 2019)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(remotes)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">install_version</span>(<span class="st">"survival"</span>, <span class="at">version =</span> <span class="st">"2.44-1"</span>, <span class="at">repos =</span> <span class="st">"http://cran.us.r-project.org"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Maj juin 2022</strong>: pour le problème du test de Grambsch-Therneau, j’ai récupéré le programme de la version 2 de survival, renommé la fonction cox.zphold. Une fois chargé avec la fonction source(…path/cox.zphold.R), on peut l’exécuter directement.</p>
</div>
</div>
<p><br></p>
</section>
<section id="analyse-non-paramétrique" class="level1">
<h1><strong>Analyse Non paramétrique</strong></h1>
<p>Chargement de la base transplantation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>trans <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://raw.githubusercontent.com/mthevenin/analyse_duree/master/bases/transplantation.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 103 Columns: 10
-- Column specification --------------------------------------------------------
Delimiter: ","
dbl (10): id, year, age, died, stime, surgery, transplant, wait, mois, compet

i Use `spec()` to retrieve the full column specification for this data.
i Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<p><br></p>
<section id="méthode-actuarielle" class="level3">
<h3 class="anchored" data-anchor-id="méthode-actuarielle"><strong>Méthode actuarielle</strong></h3>
<p>La fonction disponible du paquet <code>discsurv</code>, <em><code>lifetable</code></em>, ne permet pas de définir des intervalles, contrairement à Sas ou Stata. Les estimateurs sont systématiquement calculés sur des largeurs d’intervalle égales à 1, et il ni a pas de calcul des durées sur les différents quantiles de la courbe de survie. Elle ne sera donc pas présentée.</p>
<p><br></p>
</section>
<section id="méthode-kaplan-meier" class="level3">
<h3 class="anchored" data-anchor-id="méthode-kaplan-meier"><strong>Méthode Kaplan-Meier</strong></h3>
<p>Le package survival est le principal outil d’analyse des durée. Le package survminer permet d’améliorer la présentation des graphiques. <br></p>
<p><strong>Estimation des fonctions de survie</strong><br>
<br> Fonction <code>survfit</code><br>
Syntaxe</p>
<pre><code>fit &lt;- survfit(Surv(time, status) ~ x, data = base)</code></pre>
<p>On peut renseigner les variables permettant de calculer la durée et non la variable de durée elle-même.</p>
<pre><code>fit &lt;- survfit(Surv(variable start, variable end, status) ~ x, data = nom_base)</code></pre>
<p>Sans comparaison de groupes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(stime, died) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> trans)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(stime, died) ~ 1, data = trans)

      n  events  median 0.95LCL 0.95UCL 
    103      75     100      72     263 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(stime, died) ~ 1, data = trans)

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    1    103       1    0.990 0.00966       0.9715        1.000
    2    102       3    0.961 0.01904       0.9246        0.999
    3     99       3    0.932 0.02480       0.8847        0.982
    5     96       2    0.913 0.02782       0.8597        0.969
    6     94       2    0.893 0.03043       0.8355        0.955
    8     92       1    0.883 0.03161       0.8237        0.948
    9     91       1    0.874 0.03272       0.8119        0.940
   12     89       1    0.864 0.03379       0.8002        0.933
   16     88       3    0.835 0.03667       0.7656        0.910
   17     85       1    0.825 0.03753       0.7543        0.902
   18     84       1    0.815 0.03835       0.7431        0.894
   21     83       2    0.795 0.03986       0.7208        0.877
   28     81       1    0.785 0.04056       0.7098        0.869
   30     80       1    0.776 0.04122       0.6989        0.861
   32     78       1    0.766 0.04188       0.6878        0.852
   35     77       1    0.756 0.04250       0.6769        0.844
   36     76       1    0.746 0.04308       0.6659        0.835
   37     75       1    0.736 0.04364       0.6551        0.827
   39     74       1    0.726 0.04417       0.6443        0.818
   40     72       2    0.706 0.04519       0.6225        0.800
   43     70       1    0.696 0.04565       0.6117        0.791
   45     69       1    0.686 0.04609       0.6009        0.782
   50     68       1    0.675 0.04650       0.5902        0.773
   51     67       1    0.665 0.04689       0.5796        0.764
   53     66       1    0.655 0.04725       0.5690        0.755
   58     65       1    0.645 0.04759       0.5584        0.746
   61     64       1    0.635 0.04790       0.5479        0.736
   66     63       1    0.625 0.04819       0.5374        0.727
   68     62       2    0.605 0.04870       0.5166        0.708
   69     60       1    0.595 0.04892       0.5063        0.699
   72     59       2    0.575 0.04929       0.4857        0.680
   77     57       1    0.565 0.04945       0.4755        0.670
   78     56       1    0.554 0.04958       0.4654        0.661
   80     55       1    0.544 0.04970       0.4552        0.651
   81     54       1    0.534 0.04979       0.4451        0.641
   85     53       1    0.524 0.04986       0.4351        0.632
   90     52       1    0.514 0.04991       0.4251        0.622
   96     51       1    0.504 0.04994       0.4151        0.612
  100     50       1    0.494 0.04995       0.4052        0.602
  102     49       1    0.484 0.04993       0.3953        0.592
  110     47       1    0.474 0.04992       0.3852        0.582
  149     45       1    0.463 0.04991       0.3749        0.572
  153     44       1    0.453 0.04987       0.3647        0.562
  165     43       1    0.442 0.04981       0.3545        0.551
  186     41       1    0.431 0.04975       0.3440        0.541
  188     40       1    0.420 0.04966       0.3336        0.530
  207     39       1    0.410 0.04954       0.3233        0.519
  219     38       1    0.399 0.04940       0.3130        0.509
  263     37       1    0.388 0.04923       0.3027        0.498
  285     35       2    0.366 0.04885       0.2817        0.475
  308     33       1    0.355 0.04861       0.2713        0.464
  334     32       1    0.344 0.04834       0.2610        0.453
  340     31       1    0.333 0.04804       0.2507        0.442
  342     29       1    0.321 0.04773       0.2401        0.430
  583     21       1    0.306 0.04785       0.2252        0.416
  675     17       1    0.288 0.04830       0.2073        0.400
  733     16       1    0.270 0.04852       0.1898        0.384
  852     14       1    0.251 0.04873       0.1712        0.367
  979     11       1    0.228 0.04934       0.1491        0.348
  995     10       1    0.205 0.04939       0.1279        0.329
 1032      9       1    0.182 0.04888       0.1078        0.308
 1386      6       1    0.152 0.04928       0.0804        0.287</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="R_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Le premier output <code>fit</code> permet d’obtenir la durée médiane, ici égale à 100 (<span class="math inline">\(S(100)=0.494\)</span>). Le second , avec la fonction <strong><code>summary</code></strong> permet d’obtenir une table des estimateurs. La fonction de survie peut être tracée avec la fonction <strong><code>plot</code></strong> (en pointillés les intervalles de confiance).</p>
<p><br> On peut obtenir des graphes de meilleurs qualité avec la librairie <strong><code>survminer</code></strong>.<br>
Avec la fonction <strong><code>ggsurvplot</code></strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(fit, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="R_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>On peut ajouter la population encore soumise au risque à plusieurs points d’observation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(fit, <span class="at">conf.int =</span> <span class="cn">TRUE</span>, <span class="at">risk.table =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="R_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>Comparaison des fonctions de survie</strong></p>
<p>On va comparer les fonctions de survie pour la variable <em>surgery</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(stime, died) <span class="sc">~</span> surgery, <span class="at">data =</span> trans)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(stime, died) ~ surgery, data = trans)

           n events median 0.95LCL 0.95UCL
surgery=0 91     69     78      61     153
surgery=1 12      6    979     583      NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(fit, <span class="at">conf.int =</span> <span class="cn">TRUE</span>, <span class="at">risk.table =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="R_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>Tests du log-rank</strong></p>
<p>On utilise la fonction <strong><code>survdiff</code></strong>, avec comme variante le test de Peto-Peto (<code>rho=1</code>).<br>
La syntaxe est quasiment identique à la fonction <code>survdiff</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">survdiff</span>(<span class="fu">Surv</span>(stime, died) <span class="sc">~</span> surgery, <span class="at">rho=</span><span class="dv">1</span>, <span class="at">data =</span> trans)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survdiff(formula = Surv(stime, died) ~ surgery, data = trans, 
    rho = 1)

           N Observed Expected (O-E)^2/E (O-E)^2/V
surgery=0 91    45.28    39.12     0.968      8.65
surgery=1 12     2.03     8.18     4.630      8.65

 Chisq= 8.7  on 1 degrees of freedom, p= 0.003 </code></pre>
</div>
</div>
<p>Ici la variable est binaire. Si on veux tester deux à deux les niveaux d’une variable catégorielle à plus de deux modalités, on utilise la fonction <strong><code>pairwise_survdiff</code></strong> de <code>survminer</code> (syntaxe identique que <code>survdiff</code>).</p>
<p><strong>Comparaison des RMST</strong></p>
<p>La fonction <strong><code>rmst2</code></strong> du package <strong><code>survRM2</code></strong> permet de comparer les RMST entre 2 groupes (et pas plus). La strate pour les comparaisons doit être renommée <em>arm</em>. La fonction, issue d’une commande de Stata, n’est pas très souple.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>trans<span class="sc">$</span>arm<span class="ot">=</span>trans<span class="sc">$</span>surgery</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>a<span class="ot">=</span><span class="fu">rmst2</span>(trans<span class="sc">$</span>stime, trans<span class="sc">$</span>died, trans<span class="sc">$</span>arm, <span class="at">tau=</span><span class="cn">NULL</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
The truncation time, tau, was not specified. Thus, the default tau  1407  is used. 

Restricted Mean Survival Time (RMST) by arm 
                Est.      se lower .95 upper .95
RMST (arm=1) 884.576 151.979   586.702  1182.450
RMST (arm=0) 379.148  58.606   264.283   494.012


Restricted Mean Time Lost (RMTL) by arm 
                 Est.      se lower .95 upper .95
RMTL (arm=1)  522.424 151.979   224.550   820.298
RMTL (arm=0) 1027.852  58.606   912.988  1142.717


Between-group contrast 
                        Est. lower .95 upper .95     p
RMST (arm=1)-(arm=0) 505.428   186.175   824.682 0.002
RMST (arm=1)/(arm=0)   2.333     1.483     3.670 0.000
RMTL (arm=1)/(arm=0)   0.508     0.284     0.909 0.022</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="R_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><br></p>
</section>
</section>
<section id="modèle-de-cox" class="level1">
<h1><strong>Modèle de Cox</strong></h1>
<p>Ici tout est estimé avec des fonctions du package <code>survival</code>:</p>
<ul>
<li>Estimation du modèle: <code>coxph</code>.</li>
<li>Test de Grambsch-Therneau: <code>cox.zph</code>.</li>
<li>Introduction d’une variable dynamique: <code>survsplit</code>.</li>
</ul>
<section id="estimation-du-modèle" class="level2">
<h2 class="anchored" data-anchor-id="estimation-du-modèle"><strong>Estimation du modèle</strong></h2>
<p>Par défaut, R utilise la correction d’Efron pour les évènements simultanés. Il est préférable de ne pas la modifier.</p>
<p>Syntaxe:</p>
<pre><code>coxph(Surv(time, status) ~ x1 + x2 + ....., data=base, ties="nom_correction"))</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>coxfit <span class="ot">=</span> <span class="fu">coxph</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(stime, died) <span class="sc">~</span> year <span class="sc">+</span> age <span class="sc">+</span> surgery, <span class="at">data =</span> trans)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(coxfit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(stime, died) ~ year + age + surgery, data = trans)

  n= 103, number of events= 75 

            coef exp(coef) se(coef)      z Pr(&gt;|z|)  
year    -0.11963   0.88725  0.06734 -1.776   0.0757 .
age      0.02958   1.03002  0.01352  2.187   0.0287 *
surgery -0.98732   0.37257  0.43626 -2.263   0.0236 *
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

        exp(coef) exp(-coef) lower .95 upper .95
year       0.8872     1.1271    0.7775    1.0124
age        1.0300     0.9709    1.0031    1.0577
surgery    0.3726     2.6840    0.1584    0.8761

Concordance= 0.653  (se = 0.032 )
Likelihood ratio test= 17.63  on 3 df,   p=5e-04
Wald test            = 15.76  on 3 df,   p=0.001
Score (logrank) test = 16.71  on 3 df,   p=8e-04</code></pre>
</div>
</div>
<p>La table des résultats reporte le logarithme des Risques Ratios (coef) ainsi que les RR (exp(coef)). Il est intéressant de regarder la valeur de concordance (Harrel’s) qui donne des indications sur la qualité de l’ajustement (proche de l’AUC/ROC).</p>
<p>On peut représenter sous forme graphique les résultats avec la fonction <strong><code>ggforest</code></strong> de <code>survminer</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggforest</span>(coxfit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in .get_data(model, data = data): The `data` argument is not provided.
Data will be extracted from model fit.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="R_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="hypothèse-ph" class="level2">
<h2 class="anchored" data-anchor-id="hypothèse-ph"><strong>Hypothèse PH</strong></h2>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Attention aux résultats entre la v2 et la v3 de survival. Les deux sont présentés, avec un test reposant sur une régression linéaire (OLS même si GLS préférable) entre les résidus de Schoenfeld et une fonction de la durée (ici f(t)=t), et fait rapidement le 17 mai. Pour illustrer la question les résultats du test de Grambsch-Therneau sont donnés pour les deux versions.</p>
</div>
</div>
<p><strong>Résidus de Schoenfeld</strong><br>
On utilise la fonction <strong><code>cox.zph</code></strong> pour le test de <em>Grambsch-Therneau</em>.<br>
Le test peut utiliser plusieurs fonctions de la durée. Par défaut la fonction utilise <span class="math inline">\(1-KM\)</span>, soit le complémentaire de l’estimateur de Kaplan-Meier (option <code>transform="km"</code>).</p>
<p><strong><em>Test Grambsch-Therneau</em></strong></p>
<p><strong><span style="color:red">Résultat du test avec la v2 de survival</span></strong></p>
<p>Avec <code>transform="km"</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cox.zph</span>(coxfit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          rho chisq      p
year    0.159  1.96 0.1620
age     0.109  1.15 0.2845
surgery 0.251  3.96 0.0465
GLOBAL     NA  7.99 0.0462</code></pre>
</div>
</div>
<p>Avec <code>transform="identity"</code> (<span class="math inline">\(f(t)=t\)</span>) [remarque: solution de Stata par défaut].</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cox.zph</span>(coxfit, <span class="at">transform=</span><span class="st">"identity"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          rho chisq      p
year    0.102 0.797 0.3720
age     0.129 1.612 0.2043
surgery 0.297 5.539 0.0186
GLOBAL     NA 8.756 0.0327</code></pre>
</div>
</div>
<p><strong><span style="color:red">Résultat du test avec la v3 de survival</span></strong></p>
<pre><code> cox.zph(coxfit)
        chisq df     p
year    3.309  1 0.069
age     0.922  1 0.337
surgery 5.494  1 0.019
GLOBAL  8.581  3 0.035


cox.zph(coxfit, transform="identity")
        chisq df     p
year     4.54  1 0.033
age      1.71  1 0.191
surgery  4.92  1 0.027
GLOBAL   9.47  3 0.02
</code></pre>
<p>La différence est flagrante, en particulier pour la variable <em>year</em>.<br>
<br> Remarque: avec la v3, quelques options ont été ajoutées tel que <em><code>terms</code></em> qui permet pour une variable catégorielle à plus de deux modalités de choisir entre un sous test multiple sur la variable (k modalités =&gt; k-1 degré de liberté) et une série de tests à 1 degré de liberté sur chaque modalité (k-1 tests). De mon point de vue préférer la seconde solution avec <strong><code>terms=FALSE</code></strong>.</p>
<p><strong>MAJ JUIN 2022 : cox.zphold</strong></p>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p><span style="color:red"> J’ai récupéré la fonction de la version précédente de survival (identique Sas, Stata, Python) et renommé cox.zphold. Elle est téléchargeable à cette adresse :(https://github.com/mthevenin/analyse_duree/tree/main/cox.zphold).</span></p>
<ul>
<li>Une fois enregistré, charger dans le programme d’analyse la fonction</li>
<li>Après avoir estimé le modèle de Cox, exécuter la fonction <strong><code>cox.zphold()</code></strong></li>
</ul>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"D:/D/Marc/SMS/FORMATIONS/2022/Durée2/a distribuer/cox.zphold.R"</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>coxfit <span class="ot">=</span> <span class="fu">coxph</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(stime, died) <span class="sc">~</span> year <span class="sc">+</span> age <span class="sc">+</span> surgery,   <span class="at">data =</span> trans)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cox.zphold</span>(coxfit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          rho chisq      p
year    0.159  1.96 0.1620
age     0.109  1.15 0.2845
surgery 0.251  3.96 0.0465
GLOBAL     NA  7.99 0.0462</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cox.zphold</span>(coxfit, <span class="at">transform=</span><span class="st">"identity"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          rho chisq      p
year    0.102 0.797 0.3720
age     0.129 1.612 0.2043
surgery 0.297 5.539 0.0186
GLOBAL     NA 8.756 0.0327</code></pre>
</div>
</div>
<p><strong><em>Régression linéaire entre les résidus standardisés et la durée</em></strong></p>
<ul>
<li>Seulement eu le temps pour <span class="math inline">\(ft(t)=t\)</span>.</li>
<li>Pas trop pénalisant pour cette application, mais trouver un moyen de récupérer les noms des variables du modèle.</li>
<li>Testé parallèlement avec Stata: ok.</li>
</ul>
<p>Etapes:</p>
<ul>
<li>Récupérer les résidus standardisés de Schoenfeld avec la fonction <strong><code>resid()</code></strong>.</li>
<li>Transformer la matrice en base, basculer les valeurs des rangs en variable (librairie <strong><code>tibble</code></strong>).</li>
<li>Transformer cette dernière variable en variable de durée (librairie <strong><code>stringr</code></strong>: extraction de la durée).</li>
<li>Exécuter une régression linéaire sur chaque variable: $ residu_{x_i}= a_0 + bt$ [ici une OLS, mais GLS préférable].</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Récupération des résidus</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>resid<span class="ot">=</span> <span class="fu">resid</span>(coxfit, <span class="at">type=</span><span class="st">"scaledsch"</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>resid <span class="ot">=</span> <span class="fu">data.frame</span>(resid)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Récupération des rangs en variable pour générer la durée</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>resid<span class="ot">=</span> <span class="fu">rownames_to_column</span>(resid, <span class="at">var =</span> <span class="st">"Z"</span>)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Création de la variable de durée</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>resid<span class="sc">$</span>t <span class="ot">=</span> <span class="fu">str_sub</span>(resid<span class="sc">$</span>Z, <span class="dv">2</span>, )</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>resid<span class="sc">$</span>t<span class="ot">=</span><span class="fu">as.numeric</span>(resid<span class="sc">$</span>t)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>resid<span class="sc">$</span>t<span class="ot">=</span><span class="fu">round</span>(resid<span class="sc">$</span>t, <span class="at">digits=</span><span class="dv">0</span>)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="co"># ols entre les résidus et la durée</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>year    <span class="ot">=</span> <span class="fu">summary</span>(<span class="fu">lm</span>(X1<span class="sc">~</span>t, <span class="at">data=</span>resid))</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>age     <span class="ot">=</span> <span class="fu">summary</span>(<span class="fu">lm</span>(X2<span class="sc">~</span>t, <span class="at">data=</span>resid))</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>surgery <span class="ot">=</span> <span class="fu">summary</span>(<span class="fu">lm</span>(X3<span class="sc">~</span>t, <span class="at">data=</span>resid))</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>year<span class="sc">$</span>coefficients[,<span class="dv">4</span>] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)           t 
 0.05664549  0.38565337 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>age<span class="sc">$</span>coefficients[,<span class="dv">4</span>] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)           t 
  0.2953778   0.2686404 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>surgery<span class="sc">$</span>coefficients[,<span class="dv">4</span>] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)           t 
 0.00065017  0.00975821 </code></pre>
</div>
</div>
<p><strong>Introduction d’une intéraction</strong></p>
<p>Lorsque la covariable n’est pas continue, elle doit être transformée en indicatrice. Vérifier que les résultats du modèle sont bien identiques avec le modèle estimé précédemment (ne pas oublier d’omettre le niveau en référence).<br>
Ici la variable surgery est déjà sous forme d’indicatrice (0,1).<br>
La variable d’intéraction est <strong><code>tt(nom-variable)</code></strong>, la fonction de la durée (ici forme linéaire simple) est indiquée en option de la fonction: <strong><code>tt = function(x, t, ...) x*t</code></strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>coxfit2 <span class="ot">=</span> <span class="fu">coxph</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(stime, died) <span class="sc">~</span> year <span class="sc">+</span> age <span class="sc">+</span> surgery <span class="sc">+</span> <span class="fu">tt</span>(surgery), <span class="at">data =</span> trans, <span class="at">tt =</span> <span class="cf">function</span>(x, t, ...) x<span class="sc">*</span>t)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(coxfit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(stime, died) ~ year + age + surgery + tt(surgery), 
    data = trans, tt = function(x, t, ...) x * t)

  n= 103, number of events= 75 

                 coef exp(coef)  se(coef)      z Pr(&gt;|z|)   
year        -0.123074  0.884198  0.066835 -1.841  0.06555 . 
age          0.028888  1.029310  0.013449  2.148  0.03172 * 
surgery     -1.754738  0.172953  0.674391 -2.602  0.00927 **
tt(surgery)  0.002231  1.002234  0.001102  2.024  0.04299 * 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

            exp(coef) exp(-coef) lower .95 upper .95
year           0.8842     1.1310   0.77564    1.0080
age            1.0293     0.9715   1.00253    1.0568
surgery        0.1730     5.7819   0.04612    0.6486
tt(surgery)    1.0022     0.9978   1.00007    1.0044

Concordance= 0.656  (se = 0.032 )
Likelihood ratio test= 21.58  on 4 df,   p=2e-04
Wald test            = 16.99  on 4 df,   p=0.002
Score (logrank) test = 19  on 4 df,   p=8e-04</code></pre>
</div>
</div>
<p><strong>Rappel</strong>: le paramètre estimé pour <strong><code>tt(surgery)</code></strong> ne reporte pas un Risques Ratio, mais un rapport de Risques Ratio.</p>
<p><br></p>
</section>
<section id="variable-dynamique-binaire" class="level2">
<h2 class="anchored" data-anchor-id="variable-dynamique-binaire"><strong>Variable dynamique (binaire)</strong></h2>
<p>La dimension dynamique est le fait d’avoir été opéré pour une greffe du coeur.<br>
<br></p>
<ul>
<li><strong>Etape 1</strong>: créer un vecteur donnant les durées aux temps d’évènement.</li>
<li><strong>Etape 2</strong>: appliquer ce vecteurs de points de coupure à la fonction <code>survsplit</code>.</li>
<li><strong>Etape 3</strong>: modifier la variable transplant (ou créer une nouvelle) à l’aide de la variable <strong>wait</strong> qui prend la valeur 1 à partir du jour de la greffe, 0 avant.</li>
</ul>
<p><em>Etape 1</em> Création de l’objet cut (vecteur)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>cut<span class="ot">=</span> <span class="fu">unique</span>(trans<span class="sc">$</span>stime[trans<span class="sc">$</span>died <span class="sc">==</span> <span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>Etape 2</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>tvc <span class="ot">=</span> <span class="fu">survSplit</span>(<span class="at">data =</span> trans, <span class="at">cut =</span> cut, <span class="at">end =</span> <span class="st">"stime"</span>, <span class="at">start =</span> <span class="st">"stime0"</span>, <span class="at">event =</span> <span class="st">"died"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Remarque: pour estimer le modèle de Cox de départ avec cette base longue.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coxph</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(stime0, stime, died) <span class="sc">~</span> year <span class="sc">+</span> age <span class="sc">+</span> surgery, <span class="at">data =</span> tvc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(stime0, stime, died) ~ year + age + surgery, 
    data = tvc)

            coef exp(coef) se(coef)      z      p
year    -0.11963   0.88725  0.06734 -1.776 0.0757
age      0.02958   1.03002  0.01352  2.187 0.0287
surgery -0.98732   0.37257  0.43626 -2.263 0.0236

Likelihood ratio test=17.63  on 3 df, p=0.0005243
n= 3573, number of events= 75 </code></pre>
</div>
</div>
<p><em>Etape 3</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>tvc<span class="sc">$</span>tvc<span class="ot">=</span><span class="fu">ifelse</span>(tvc<span class="sc">$</span>transplant<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> tvc<span class="sc">$</span>wait<span class="sc">&lt;=</span>tvc<span class="sc">$</span>stime,<span class="dv">1</span>,<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Estimation du modèle</strong><br>
En format long, on doit préciser dans la formule l’intervalle de durée avec les variables stime0 (début) et stime(fin)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>tvcfit <span class="ot">=</span> <span class="fu">coxph</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(stime0, stime, died) <span class="sc">~</span> year <span class="sc">+</span> age <span class="sc">+</span> surgery <span class="sc">+</span> tvc, <span class="at">data =</span> tvc)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(tvcfit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(stime0, stime, died) ~ year + age + surgery + 
    tvc, data = tvc)

  n= 3573, number of events= 75 

            coef exp(coef) se(coef)      z Pr(&gt;|z|)  
year    -0.12032   0.88664  0.06734 -1.787   0.0740 .
age      0.03044   1.03091  0.01390  2.190   0.0285 *
surgery -0.98289   0.37423  0.43655 -2.251   0.0244 *
tvc     -0.08221   0.92108  0.30484 -0.270   0.7874  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

        exp(coef) exp(-coef) lower .95 upper .95
year       0.8866      1.128    0.7770    1.0117
age        1.0309      0.970    1.0032    1.0594
surgery    0.3742      2.672    0.1591    0.8805
tvc        0.9211      1.086    0.5068    1.6741

Concordance= 0.659  (se = 0.032 )
Likelihood ratio test= 17.7  on 4 df,   p=0.001
Wald test            = 15.79  on 4 df,   p=0.003
Score (logrank) test = 16.74  on 4 df,   p=0.002</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggforest</span>(tvcfit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in .get_data(model, data = data): The `data` argument is not provided.
Data will be extracted from model fit.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="R_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><br></p>
</section>
</section>
<section id="analyse-en-temps-discret" class="level1">
<h1><strong>Analyse en temps discret</strong></h1>
<p>Pour la durée, on va utiliser la variable mois (en fait regroupement sur 30 jours).<br>
La fonction <code>uncount</code> du package <code>tidy</code> permettra de splitter la base au temps d’observation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tidyr"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> <span class="fu">uncount</span>(trans,mois)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> dt[<span class="fu">order</span>(dt<span class="sc">$</span>id),]</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(dt[<span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>, ],)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

| id| year| age| died| stime| surgery| transplant| wait| compet| arm|
|--:|----:|---:|----:|-----:|-------:|----------:|----:|------:|---:|
|  1|   67|  30|    1|    50|       0|          0|    0|      1|   0|
|  1|   67|  30|    1|    50|       0|          0|    0|      1|   0|
|  2|   68|  51|    1|     6|       0|          0|    0|      1|   0|
|  3|   68|  54|    1|    16|       0|          1|    1|      1|   0|
|  4|   68|  40|    1|    39|       0|          1|   36|      2|   0|
|  4|   68|  40|    1|    39|       0|          1|   36|      2|   0|
|  5|   68|  20|    1|    18|       0|          0|    0|      1|   0|
|  6|   68|  54|    1|     3|       0|          0|    0|      2|   0|
|  7|   68|  50|    1|   675|       0|          1|   51|      1|   0|
|  7|   68|  50|    1|   675|       0|          1|   51|      1|   0|
|  7|   68|  50|    1|   675|       0|          1|   51|      1|   0|</code></pre>
</div>
</div>
<p>La variable mois a été supprimée, on va générer une variable type compteur pour mesurer la durée à chaque point d’observation. On va également recréer la variable (renommée T).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>dt<span class="sc">$</span>x<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>dt<span class="sc">$</span>t <span class="ot">=</span> <span class="fu">ave</span>(dt<span class="sc">$</span>x,dt<span class="sc">$</span>id, <span class="at">FUN=</span>cumsum)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>dt<span class="sc">$</span>T <span class="ot">=</span> <span class="fu">ave</span>(dt<span class="sc">$</span>x,dt<span class="sc">$</span>id, <span class="at">FUN=</span>sum)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(dt[<span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>, ],)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

| id| year| age| died| stime| surgery| transplant| wait| compet| arm|  x|  t|  T|
|--:|----:|---:|----:|-----:|-------:|----------:|----:|------:|---:|--:|--:|--:|
|  1|   67|  30|    1|    50|       0|          0|    0|      1|   0|  1|  1|  2|
|  1|   67|  30|    1|    50|       0|          0|    0|      1|   0|  1|  2|  2|
|  2|   68|  51|    1|     6|       0|          0|    0|      1|   0|  1|  1|  1|
|  3|   68|  54|    1|    16|       0|          1|    1|      1|   0|  1|  1|  1|
|  4|   68|  40|    1|    39|       0|          1|   36|      2|   0|  1|  1|  2|
|  4|   68|  40|    1|    39|       0|          1|   36|      2|   0|  1|  2|  2|
|  5|   68|  20|    1|    18|       0|          0|    0|      1|   0|  1|  1|  1|
|  6|   68|  54|    1|     3|       0|          0|    0|      2|   0|  1|  1|  1|
|  7|   68|  50|    1|   675|       0|          1|   51|      1|   0|  1|  1| 23|
|  7|   68|  50|    1|   675|       0|          1|   51|      1|   0|  1|  2| 23|
|  7|   68|  50|    1|   675|       0|          1|   51|      1|   0|  1|  3| 23|</code></pre>
</div>
</div>
<p><em>Remarque : j’utilise ici le code standard de R, on peut faire la même chose avec dplyr de manière plus rapide (mise à jour à prévoir)</em>.<br>
<br> Si un individu est décédé, died=1 est reporté sur toute les lignes (idem qu’avec la variable dynamique). On va modifier la variable tel que <em>died=0 si t&lt;T$</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>dt<span class="sc">$</span>died[dt<span class="sc">$</span>t<span class="sc">&lt;</span>dt<span class="sc">$</span>T]<span class="ot">=</span><span class="dv">0</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(dt[<span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>, ],)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

| id| year| age| died| stime| surgery| transplant| wait| compet| arm|  x|  t|  T|
|--:|----:|---:|----:|-----:|-------:|----------:|----:|------:|---:|--:|--:|--:|
|  1|   67|  30|    0|    50|       0|          0|    0|      1|   0|  1|  1|  2|
|  1|   67|  30|    1|    50|       0|          0|    0|      1|   0|  1|  2|  2|
|  2|   68|  51|    1|     6|       0|          0|    0|      1|   0|  1|  1|  1|
|  3|   68|  54|    1|    16|       0|          1|    1|      1|   0|  1|  1|  1|
|  4|   68|  40|    0|    39|       0|          1|   36|      2|   0|  1|  1|  2|
|  4|   68|  40|    1|    39|       0|          1|   36|      2|   0|  1|  2|  2|
|  5|   68|  20|    1|    18|       0|          0|    0|      1|   0|  1|  1|  1|
|  6|   68|  54|    1|     3|       0|          0|    0|      2|   0|  1|  1|  1|
|  7|   68|  50|    0|   675|       0|          1|   51|      1|   0|  1|  1| 23|
|  7|   68|  50|    0|   675|       0|          1|   51|      1|   0|  1|  2| 23|
|  7|   68|  50|    0|   675|       0|          1|   51|      1|   0|  1|  3| 23|</code></pre>
</div>
</div>
<p><br></p>
<section id="durée-continue" class="level2">
<h2 class="anchored" data-anchor-id="durée-continue"><strong>Durée continue</strong></h2>
<p>Avec un effet quadratique d’ordre 2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>dt<span class="sc">$</span>t2<span class="ot">=</span>dt<span class="sc">$</span>t<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>dtfit <span class="ot">=</span> <span class="fu">glm</span>(died <span class="sc">~</span> t <span class="sc">+</span> t2 <span class="sc">+</span> year <span class="sc">+</span> age <span class="sc">+</span> surgery, <span class="at">data=</span>dt, <span class="at">family=</span><span class="st">"binomial"</span>)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summ</span>(dtfit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MODEL INFO:
Observations: 1127
Dependent Variable: died
Type: Generalized linear model
  Family: binomial 
  Link function: logit 

MODEL FIT:
&lt;U+03C7&gt;²(5) = 84.70, p = 0.00
Pseudo-R² (Cragg-Uhler) = 0.19
Pseudo-R² (McFadden) = 0.15
AIC = 478.67, BIC = 508.83 

Standard errors: MLE
------------------------------------------------
                     Est.   S.E.   z val.      p
----------------- ------- ------ -------- ------
(Intercept)          7.74   5.22     1.48   0.14
t                   -0.20   0.04    -5.63   0.00
t2                   0.00   0.00     3.98   0.00
year                -0.15   0.07    -2.04   0.04
age                  0.03   0.01     2.35   0.02
surgery             -1.00   0.45    -2.24   0.02
------------------------------------------------</code></pre>
</div>
</div>
<p>Remarque sur la présentation: la fonction <code>summ</code> est intégrée au package <code>jtools</code>. Elle ne fonctionne qu’avec le package <code>Recordlinkage</code> qui doit être installé et chargé.</p>
<p><br></p>
</section>
<section id="durée-discrète" class="level2">
<h2 class="anchored" data-anchor-id="durée-discrète"><strong>Durée discrète</strong></h2>
<p>On va créer une variable de type dicrète regroupant la variable <em>t</em> en quartile (pour l’exemple seulement, tous types de regroupement est envisageable).<br>
On va utiliser la fonction <code>quantcut</code> du package <code>gtools</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>dt<span class="sc">$</span>ct4 <span class="ot">&lt;-</span> <span class="fu">quantcut</span>(dt<span class="sc">$</span>t)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(dt<span class="sc">$</span>ct4) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  [1,4]  (4,11] (11,23] (23,60] 
    299     275     282     271 </code></pre>
</div>
</div>
<p>On va générer un compteur et un total d’observations sur la strate regroupant <em>id</em> et <em>ct4</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>dt<span class="sc">$</span>n <span class="ot">=</span> <span class="fu">ave</span>(dt<span class="sc">$</span>x,dt<span class="sc">$</span>id, dt<span class="sc">$</span>ct4, <span class="at">FUN=</span>cumsum)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>dt<span class="sc">$</span>N <span class="ot">=</span> <span class="fu">ave</span>(dt<span class="sc">$</span>x,dt<span class="sc">$</span>id, dt<span class="sc">$</span>ct4, <span class="at">FUN=</span>sum)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>On conserve la dernière observation dans la strate.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>dt2 <span class="ot">=</span> <span class="fu">subset</span>(dt, n<span class="sc">==</span>N)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Estimation du modèle</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">=</span> <span class="fu">glm</span>(died <span class="sc">~</span> ct4 <span class="sc">+</span> year <span class="sc">+</span> age <span class="sc">+</span> surgery, <span class="at">data=</span>dt2, <span class="at">family=</span>binomial)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summ</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MODEL INFO:
Observations: 197
Dependent Variable: died
Type: Generalized linear model
  Family: binomial 
  Link function: logit 

MODEL FIT:
&lt;U+03C7&gt;²(6) = 39.30, p = 0.00
Pseudo-R² (Cragg-Uhler) = 0.25
Pseudo-R² (McFadden) = 0.15
AIC = 236.48, BIC = 259.46 

Standard errors: MLE
------------------------------------------------
                     Est.   S.E.   z val.      p
----------------- ------- ------ -------- ------
(Intercept)         12.45   6.65     1.87   0.06
ct4(4,11]           -1.03   0.42    -2.47   0.01
ct4(11,23]          -1.62   0.54    -2.96   0.00
ct4(23,60]          -0.48   0.60    -0.80   0.42
year                -0.20   0.09    -2.18   0.03
age                  0.05   0.02     2.53   0.01
surgery             -1.11   0.50    -2.21   0.03
------------------------------------------------</code></pre>
</div>
</div>
<p><br></p>
</section>
</section>
<section id="modèles-pusuels" class="level1">
<h1><strong>Modèles pusuels</strong></h1>
<p>On utilise la fonction <code>survreg</code> du package <code>survival</code></p>
<section id="modèle-de-weibull" class="level2">
<h2 class="anchored" data-anchor-id="modèle-de-weibull"><strong>Modèle de Weibull</strong></h2>
<p><strong>De type AFT</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>weibull <span class="ot">=</span> <span class="fu">survreg</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(stime, died) <span class="sc">~</span> year <span class="sc">+</span> age <span class="sc">+</span> surgery, <span class="at">data =</span> trans, <span class="at">dist=</span><span class="st">"weibull"</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(weibull)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
survreg(formula = Surv(stime, died) ~ year + age + surgery, data = trans, 
    dist = "weibull")
              Value Std. Error     z       p
(Intercept) -3.0220     8.7284 -0.35   0.729
year         0.1620     0.1218  1.33   0.184
age         -0.0615     0.0247 -2.49   0.013
surgery      1.9703     0.7794  2.53   0.011
Log(scale)   0.5868     0.0927  6.33 2.5e-10

Scale= 1.8 

Weibull distribution
Loglik(model)= -488.2   Loglik(intercept only)= -497.6
    Chisq= 18.87 on 3 degrees of freedom, p= 0.00029 
Number of Newton-Raphson Iterations: 5 
n= 103 </code></pre>
</div>
</div>
<p><strong>De type PH</strong><br>
<br> La paramétrisation PH n’est pas possible avec la fonction <code>survreg</code>.<br>
Il faut utiliser le package <code>flexsurv</code>, qui permet également d’estimer les modèles paramétriques disponibles avec <code>survival</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(flexsurv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Pour estimer le modèle de Weibull de type PH, on utilise en option <code>dist="weibullPH"</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">flexsurvreg</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(stime, died) <span class="sc">~</span> year <span class="sc">+</span> age <span class="sc">+</span> surgery, <span class="at">data =</span> trans, <span class="at">dist=</span><span class="st">"weibullPH"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
flexsurvreg(formula = Surv(stime, died) ~ year + age + surgery, 
    data = trans, dist = "weibullPH")

Estimates: 
         data mean  est        L95%       U95%       se         exp(est) 
shape           NA   5.56e-01   4.64e-01   6.67e-01   5.16e-02         NA
scale           NA   5.37e+00   4.27e-04   6.75e+04   2.59e+01         NA
year      7.06e+01  -9.01e-02  -2.20e-01   3.97e-02   6.62e-02   9.14e-01
age       4.46e+01   3.42e-02   7.13e-03   6.13e-02   1.38e-02   1.03e+00
surgery   1.17e-01  -1.10e+00  -1.95e+00  -2.45e-01   4.34e-01   3.34e-01
         L95%       U95%     
shape           NA         NA
scale           NA         NA
year      8.03e-01   1.04e+00
age       1.01e+00   1.06e+00
surgery   1.43e-01   7.83e-01

N = 103,  Events: 75,  Censored: 28
Total time at risk: 31938
Log-likelihood = -488.1683, df = 5
AIC = 986.3366</code></pre>
</div>
</div>
<p><br></p>
</section>
</section>
<section id="risques-concurrents" class="level1">
<h1><strong>Risques concurrents</strong></h1>
<p>Package <code>cmprsk</code> pour l’analyse paramétrique et le modèle de Fine-Gray.</p>
<p>Package cmprsk pour l’analyse non paramétrique et le modèle de Fine-Gray. La variable de censure/évènement, <em>compet</em>, correspond à la variable died avec une modalité supplémentaire simulée. On suppose l’existence d’une cause supplémentaire au décès autre qu’une malformation cardiaque et non strictement indépendante de cell-ci.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>compet <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://raw.githubusercontent.com/mthevenin/analyse_duree/master/bases/transplantation.csv"</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="co"># variable compet</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(compet<span class="sc">$</span>compet) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 0  1  2 
28 56 19 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># variable died</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(compet<span class="sc">$</span>died) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 0  1 
28 75 </code></pre>
</div>
</div>
<section id="incidences-cumulées" class="level2">
<h2 class="anchored" data-anchor-id="incidences-cumulées"><strong>Incidences cumulées</strong></h2>
<p>On utilise la fonction <code>cuminc</code> du package <code>cmprsk</code>.</p>
<p><em>Pas de comparaison</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>ic <span class="ot">=</span> <span class="fu">cuminc</span>(compet<span class="sc">$</span>stime, compet<span class="sc">$</span>compet)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>ic </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Estimates and Variances:
$est
          500      1000      1500
1 1 0.5067598 0.5808345 0.6340038
1 2 0.1720161 0.2140841 0.2140841

$var
            500        1000        1500
1 1 0.002619449 0.003131847 0.003676516
1 2 0.001473283 0.002203770 0.002203770</code></pre>
</div>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ic)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="R_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Avec survminer</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcompetingrisks</span>(<span class="at">fit =</span> ic)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="R_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><em>Comparaison</em></p>
<p>Le test de Gray est automatiquement exécuté.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>ic <span class="ot">=</span> <span class="fu">cuminc</span>(compet<span class="sc">$</span>stime, compet<span class="sc">$</span>compet, <span class="at">group=</span>compet<span class="sc">$</span>surgery, <span class="at">rho=</span><span class="dv">1</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>ic </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Tests:
      stat         pv df
1 4.604792 0.03188272  1
2 0.272147 0.60189515  1
Estimates and Variances:
$est
           500      1000      1500
0 1 0.54917896 0.5940358 0.6604903
1 1 0.18181818 0.4242424        NA
0 2 0.18168014 0.2066006 0.2066006
1 2 0.09090909 0.2121212        NA

$var
            500        1000        1500
0 1 0.002955869 0.003335897 0.004199157
1 1 0.014958678 0.033339569          NA
0 2 0.001727112 0.002271242 0.002271242
1 2 0.008449138 0.022024737          NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ic)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="R_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Avec survminer. Pour avoir un seul graphique pour toutes les courbes ajouter l’option <strong><code>multiple_panels = F</code></strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcompetingrisks</span>(<span class="at">fit =</span> ic)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="R_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcompetingrisks</span>(<span class="at">fit =</span> ic, <span class="at">multiple_panels =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="R_files/figure-html/unnamed-chunk-40-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><br></p>
</section>
<section id="modèles" class="level2">
<h2 class="anchored" data-anchor-id="modèles"><strong>Modèles</strong></h2>
<section id="fine-gray" class="level3">
<h3 class="anchored" data-anchor-id="fine-gray">** Fine-Gray**</h3>
<p>Attention à l’interprétation des “risks ratio”.</p>
<p>Fonction <code>crr</code> du plackage <code>cmprsk</code>.<br>
Peu pratique les covariables doivent être introduites sous forme de matrice (n observation * k variables). Pour les covariables discrètes, prévoir la forme binaire et l’omission de la catégorie de référence.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>c <span class="ot">&lt;-</span> compet[<span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"age"</span>, <span class="st">"surgery"</span>)]</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>c <span class="ot">=</span> <span class="fu">as.matrix</span>(c)</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">crr</span>(compet<span class="sc">$</span>stime, compet<span class="sc">$</span>compet, c))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Competing Risks Regression

Call:
crr(ftime = compet$stime, fstatus = compet$compet, cov1 = c)

           coef exp(coef) se(coef)     z p-value
year    -0.0724     0.930   0.0713 -1.02   0.310
age      0.0370     1.038   0.0176  2.10   0.036
surgery -0.8688     0.419   0.4488 -1.94   0.053

        exp(coef) exp(-coef)  2.5% 97.5%
year        0.930      1.075 0.809  1.07
age         1.038      0.964 1.002  1.07
surgery     0.419      2.384 0.174  1.01

Num. cases = 103
Pseudo Log-likelihood = -228 
Pseudo likelihood ratio test = 11.2  on 3 df,</code></pre>
</div>
</div>
</section>
<section id="modèle-multinomial" class="level3">
<h3 class="anchored" data-anchor-id="modèle-multinomial"><strong>Modèle multinomial</strong></h3>
<p>On va de nouveau utiliser la variable mois (temps discret).<br>
Le modèle sera estimé à l’aide la fonction <code>multinom</code> du package <code>nnet</code>, les p-values doivent-être programmées, l’output ne donnant que les erreurs-types.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("nnet")</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nnet)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: le package 'nnet' a été compilé avec la version R 4.1.3</code></pre>
</div>
</div>
<p><em>Transformation de la base</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>compet<span class="sc">$</span>T <span class="ot">=</span> compet<span class="sc">$</span>mois</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>td <span class="ot">=</span> <span class="fu">uncount</span>(compet, mois)</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>td<span class="sc">$</span>x<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>td<span class="sc">$</span>t <span class="ot">=</span> <span class="fu">ave</span>(td<span class="sc">$</span>x, td<span class="sc">$</span>id, <span class="at">FUN=</span>cumsum)</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>td<span class="sc">$</span>t2 <span class="ot">=</span> td<span class="sc">$</span>t<span class="sc">*</span>td<span class="sc">$</span>t</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>td<span class="sc">$</span>e <span class="ot">=</span> <span class="fu">ifelse</span>(td<span class="sc">$</span>t<span class="sc">&lt;</span>td<span class="sc">$</span>T,<span class="dv">0</span>, td<span class="sc">$</span>compet)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>Estimation</em></p>
<p>Pour estimer le modèle, on utilise la fonction <code>mlogit</code> du package <code>nnet</code>. Les p-values seront calculées à partir d’un test bilatéral (statistique z).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>competfit <span class="ot">=</span> <span class="fu">multinom</span>(<span class="at">formula =</span> e <span class="sc">~</span> t <span class="sc">+</span> t2 <span class="sc">+</span> year <span class="sc">+</span> age <span class="sc">+</span> surgery, <span class="at">data =</span> td)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># weights:  21 (12 variable)
initial  value 1238.136049 
iter  10 value 579.836377
iter  20 value 387.824428
iter  30 value 277.775477
iter  40 value 275.151304
iter  50 value 275.005454
final  value 275.005419 
converged</code></pre>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(competfit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
multinom(formula = e ~ t + t2 + year + age + surgery, data = td)

Coefficients:
  (Intercept)          t          t2       year        age    surgery
1    5.646796 -0.2034545 0.003168301 -0.1284492 0.04389670 -1.1471457
2   11.316123 -0.2023134 0.002981492 -0.2036701 0.01100051 -0.6137982

Std. Errors:
  (Intercept)          t           t2       year        age   surgery
1 0.007756736 0.04130290 0.0008964768 0.01166713 0.01688253 0.5319373
2 0.013113980 0.06898341 0.0015340216 0.01613615 0.02404470 0.7612701

Residual Deviance: 550.0108 
AIC: 574.0108 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>z <span class="ot">=</span> <span class="fu">summary</span>(competfit)<span class="sc">$</span>coefficients<span class="sc">/</span><span class="fu">summary</span>(competfit)<span class="sc">$</span>standard.errors</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">pnorm</span>(<span class="fu">abs</span>(z), <span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">*</span> <span class="dv">2</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  (Intercept)            t           t2 year         age    surgery
1           0 8.396729e-07 0.0004090588    0 0.009318953 0.03104129
2           0 3.359389e-03 0.0519462468    0 0.647310003 0.42008041</code></pre>
</div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } 
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./frailty.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Fragilité et immunité</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./Stata.html" class="pagination-link">
        <span class="nav-page-text">Stata</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center">Marc Thévenin - Ined-Sms - Août 2022</div>
  </div>
</footer>



</body></html>