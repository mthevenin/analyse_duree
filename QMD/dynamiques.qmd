---
title: "Variables dynamiques"
---

Cette section sera principalement traitée par l'exemple, et on ne s'intéressera qu'aux variables de type discrète.

-   Dans un modèle de durée, une variable dynamique peut-être appréhendée comme une intéraction entre la durée et une variable quantitative.
-   Pour un modèle de Cox, l'hypothèse de risque proportionnel ne peut donc pas être testée sur la variable d'origine.
-   Ne pas tenir compte du caractère dynamique d'une dimension peut conduire à des interprétations erronées.
-   Warning: La façon de modéliser les dimensions dynamiques en analyse des durées peut conduire à des biais de causalité, en particulier dans les sciences sociales, en omettant les effets d'anticipation. C'est une situation classique avec des covariables dynamiques de type discrètes. Les techniques standards ne peuvent modéliser que des effets d'adaptation : la cause - observée - précède l'effet.

# Facteur dynamique traitée de manière fixe

On reprend l'exemple sur malformation cardiaque, en ajoutant la variable relative à la greffe : la transplantation réduit-elle le risque journalier de décéder (ou augmente la durée de survie).\
On a dans la base 2 variables: une variable binaire pour savoir si l'individu à été greffé, **tranplant**, et une variable continue tronquée donnant la durée en jour jusqu'à la greffe greffe (0 si pas de greffe), **wait**.\
<br> On va dans un premier temps estimer le modèle (de Cox) avec la variable fixe *transplant*.

```{r eval=FALSE}
Cox regression -- Efron method for ties

No. of subjects =          103                  Number of obs    =         103
No. of failures =           75
Time at risk    =        31938
                                                LR chi2(4)       =       49.81
Log likelihood  =   -273.21499                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------
          _t |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        year |    -0.0909     0.0659    -1.38   0.168      -0.2201      0.0383
         age |     0.0579     0.0147     3.95   0.000       0.0292      0.0866
   1.surgery |    -0.6547     0.4475    -1.46   0.143      -1.5318      0.2224
1.transplant |    -1.6484     0.2792    -5.90   0.000      -2.1957     -1.1011
------------------------------------------------------------------------------
```

Interprétation: traité de manière fixe, la greffe réduit le risque journalier de décéder de près de -81%: $(1-e^{-1.65})\times100$

Au niveau des données le modèle à été estimé, pour une personne greffée, à partir de ce mapping:

```{r eval=FALSE}
+----------------------------------------------------------------------------+
  | id   year   age   surgery  transplant  wait   _d          _t         _t0 |
  |--------------------------------------------------------------------------|
  | 10     68    42         0          1     12    0           1           0 |
  | 10     68    42         0          1     12    0           2           1 |
  | 10     68    42         0          1     12    0           3           2 |
  | 10     68    42         0          1     12    0           5           3 |
  | 10     68    42         0          1     12    0   5.0999999           5 |
  |--------------------------------------------------------------------------|
  | 10     68    42         0          1     12    0           6   5.0999999 |
  | 10     68    42         0          1     12    0           8           6 |
  | 10     68    42         0          1     12    0           9           8 |
  | 10     68    42         0          1     12    0          12           9 |
  | 10     68    42         0          1     12    0          16          12 |
  |--------------------------------------------------------------------------|
  | 10     68    42         0          1     12    0          17          16 |
  | 10     68    42         0          1     12    0          18          17 |
  | 10     68    42         0          1     12    0          21          18 |
  | 10     68    42         0          1     12    0          28          21 |
  | 10     68    42         0          1     12    0          30          28 |
  |--------------------------------------------------------------------------|
  | 10     68    42         0          1     12    0          32          30 |
  | 10     68    42         0          1     12    0          35          32 |
  | 10     68    42         0          1     12    0          36          35 |
  | 10     68    42         0          1     12    0          37          36 |
  | 10     68    42         0          1     12    0          39          37 |
  |--------------------------------------------------------------------------|
  | 10     68    42         0          1     12    0          40          39 |
  | 10     68    42         0          1     12    0          43          40 |
  | 10     68    42         0          1     12    0          45          43 |
  | 10     68    42         0          1     12    0          50          45 |
  | 10     68    42         0          1     12    0          51          50 |
  |--------------------------------------------------------------------------|
  | 10     68    42         0          1     12    0          53          51 |
  | 10     68    42         0          1     12    1          58          53 |
  +--------------------------------------------------------------------------+
```

**Problème**: une personne est codée greffée avant le jour de la transplantation. L'effet causal est donc mal mesuré si sa dimension temporelle a été ignorée, ici le jour exact de la greffe. C'est le même principe pour l'évènement, la personne est codée décédée (1) le jour du décès, et vivante avant (0).\
<br>

# Estimation avec une variable dynamique

Il convient donc de modifier l'information avec le délai d'attente jusqu'à la greffe. Quel que soit le logiciel, le principe de construction de la variable suit la logique suivante:\
$tvc = transplant$ , si $transplant=1$ et $_t<wait$ alors $tvc=0$.

### Modèle de Cox

```{r eval=FALSE}
  +---------------------------------------------------------------------+
  | id   year   age   surgery   tvc   wait   _d          _t         _t0 |
  |---------------------------------------------------------------------|
  | 10     68    42         0     0     12    0           1           0 |
  | 10     68    42         0     0     12    0           2           1 |
  | 10     68    42         0     0     12    0           3           2 |
  | 10     68    42         0     0     12    0           5           3 |
  | 10     68    42         0     0     12    0   5.0999999           5 |
  |---------------------------------------------------------------------|
  | 10     68    42         0     0     12    0           6   5.0999999 |
  | 10     68    42         0     0     12    0           8           6 |
  | 10     68    42         0     0     12    0           9           8 |
  | 10     68    42         0     1     12    0          12           9 |
  | 10     68    42         0     1     12    0          16          12 |
  |---------------------------------------------------------------------|
  | 10     68    42         0     1     12    0          17          16 |
  | 10     68    42         0     1     12    0          18          17 |
  | 10     68    42         0     1     12    0          21          18 |
  | 10     68    42         0     1     12    0          28          21 |
  | 10     68    42         0     1     12    0          30          28 |
  |---------------------------------------------------------------------|
  | 10     68    42         0     1     12    0          32          30 |
  | 10     68    42         0     1     12    0          35          32 |
  | 10     68    42         0     1     12    0          36          35 |
  | 10     68    42         0     1     12    0          37          36 |
  | 10     68    42         0     1     12    0          39          37 |
  |---------------------------------------------------------------------|
  | 10     68    42         0     1     12    0          40          39 |
  | 10     68    42         0     1     12    0          43          40 |
  | 10     68    42         0     1     12    0          45          43 |
  | 10     68    42         0     1     12    0          50          45 |
  | 10     68    42         0     1     12    0          51          50 |
  |---------------------------------------------------------------------|
  | 10     68    42         0     1     12    0          53          51 |
  | 10     68    42         0     1     12    1          58          53 |
  +---------------------------------------------------------------------+
```

Maintenant, si on estime le modèle avec cette variable dynamique qui indique clairement le moment de la transition (jour de la greffe):

```{r eval=FALSE}
Cox regression -- Efron method for ties

No. of subjects =          103                  Number of obs    =       3,668
No. of failures =           75
Time at risk    =      31938.1
                                                LR chi2(4)       =       17.70
Log likelihood  =   -289.27058                  Prob > chi2      =      0.0014

------------------------------------------------------------------------------
          _t |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        year |  -.1202612   .0673414    -1.79   0.074     -.252248    .0117256
         age |   .0304498   .0138998     2.19   0.028     .0032068    .0576929
   1.surgery |  -.9829386   .4365524    -2.25   0.024    -1.838566   -.1273116
       1.tvc |  -.0826682   .3047751    -0.27   0.786    -.6800165      .51468
------------------------------------------------------------------------------
```

La greffe n'a plus d'impact sur la survie des individus, tout du moins elle ne l'augmente pas. Cela ne signifie pas non plus que des personnes ont pu être "sauvée" grâce à cette opération (ou plutôt leur durée de vie augmentée), mais des complications lors de l'opération ou post-opératoires ou des problèmes de rejet du greffon, surtout à une époque où ces techniques étaient à leurs balbutiements, ont été également la source d'une mortalité peut-être un peu plus précoce que si la personne n'avait pas été greffée.

## Cox: solutions logiciels

::: panel-tabset
### Sas

La base n'est pas modifiée et la création de la TVC est faite "en aveugle" dans la procédure `phreg`, après l'instruction `model`. Ce n'est pas super.

### R - Stata, Python

La base doit être transformée en format long aux temps d'évènement (`survsplit` avec R, `stsplit` avec Stata) avant la création de la variable dynamique.
:::

### Modèle à temps discret

Même principe pour la construction de la variable dynamique. Pour rappel l'échelle temporelle est le mois, et on a créé en amont une variable qui transforme les jour d'attente en mois (*mwait*).

```{r eval=FALSE}
+---------------------------------------------+
  | id   year   age   surgery   tvc   mwait   t |
  |---------------------------------------------|
  | 13     68    54         0     0       2   1 |
  | 13     68    54         0     1       2   2 |
  | 13     68    54         0     1       2   3 |
  +---------------------------------------------+


Logistic regression                             Number of obs     =      1,127
                                                LR chi2(7)        =      90.73
                                                Prob > chi2       =     0.0000
Log likelihood = -230.32152                     Pseudo R2         =     0.1645

------------------------------------------------------------------------------
           e |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           t |   -.365048   .0915105    -3.99   0.000    -.5444052   -.1856907
          t2 |   .0139226   .0053256     2.61   0.009     .0034846    .0243606
          t3 |   -.000162   .0000815    -1.99   0.047    -.0003217   -2.27e-06
        year |  -.1324928   .0737516    -1.80   0.072    -.2770433    .0120577
         age |    .033829   .0149503     2.26   0.024      .004527    .0631311
     surgery |  -1.007795   .4490177    -2.24   0.025    -1.887854   -.1277365
         tvc |  -.0543011   .3114096    -0.17   0.862    -.6646528    .5560505
------------------------------------------------------------------------------
Remarque : la constante n’est pas reportée, les valeurs de la référence
n’ayant pas grand  sens (année et âge à 0)
```

# Précautions

*   Rappel: la cause doit précède l'effet.

*   Lorsque l'évènement étudié n'est pas intrinsèquement de type absorbant comme le décès, la « cause » peut se manifester ou plutôt être observée après la survenue de l'évènement étudié.Les modèles de durée standards ne peuvent pas gérer ces situations car l'observation sort du risque après la survenue de l'évènement.

* Même si la cause est bien mesurée avant l'évènement d'intérêt, un « choc » n'est peut-être qu'un point final d'un processus causal antérieur: une séparation est rarement un évènement ponctuel, une phase plus ou moins longue de mésentente dans le couple lui a vraisemblablement préexister. La datation du début d'un processus causal n'est donc pas toujours facile à mesurer.
  * **Logique d'adaptation**: la « cause » identifiée est mesurée avant l'évènement étudié.
  * **Logique d'anticipation**: la « cause » identifiée est mesurée après l'occurrence de l'évènement étudié. L'origine causale est bien antérieure à l'évènement, mais elle n'est pas directement observable.

-   Lorsque les variables dynamiques sont de type quantitatives/continues, le problème on doit aussi considérer avec des phénomènes d'anticipation sur les valeurs attendues de ces variables, observées postérieurement à l'évènement étudié. On peut introduire des « lags » dans le modèle pour saisir ce phénomène : par exemple $x_t= x_{t+1}$. Ce décalage des durées d'occurrence peut être aussi introduite pour les variables discrètes (naissance d'un enfant par exemple).
